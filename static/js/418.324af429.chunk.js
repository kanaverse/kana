(()=>{"use strict";var e={2418:(e,t,n)=>{var r,s=n(1522),o=n(7990),a=null;async function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;try{const n=await async function(e,t,n,r){let s,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if(s=null==o?await fetch(e):await fetch(e,o),!s.ok)throw new Error("oops, failed to download '"+e+"'");const a=t(s.headers.get("content-length")),l=s.body.getReader(),c=[];let i=0;for(;;){const{done:e,value:t}=await l.read();if(e)break;c.push(t),i+=t.length,n(a,i)}let u=new Uint8Array(i),f=0;for(const m of c)u.set(m,f),f+=m.length;return r(a,i),u}(e,t=>(postMessage({type:"DOWNLOAD for url: "+String(e),download:"START",url:String(e),total_bytes:String(t),msg:"Total size is "+String(t)+" bytes!"}),e),(t,n)=>{postMessage({type:"DOWNLOAD for url: "+String(e),download:"PROGRESS",url:String(e),downloaded_bytes:String(n),msg:"Progress so far, got "+String(n)+" bytes!"})},(t,n)=>{postMessage({type:"DOWNLOAD for url: "+String(e),download:"COMPLETE",url:String(e),msg:"Finished, got "+String(n)+" bytes!"})},t);return n}catch(s){let o;postMessage({type:"DOWNLOAD for url: "+String(e),download:"START",url:String(e),total_bytes:100}),o=null==t?fetch(e):fetch(e,t);var n=await o;if(!n.ok)throw new Error("failed to download '"+e+"' ("+n.status+")");var r=await n.arrayBuffer();return postMessage({type:"DOWNLOAD for url: "+String(e),download:"COMPLETE",url:String(e)}),new Uint8Array(r)}}async function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(await a,!n){let t=r.result.transaction(["downloads"],"readonly").objectStore("downloads");var s=new Promise((n,r)=>{var s=t.get(e);s.onsuccess=e=>{void 0!==s.result?n(s.result.payload):n(null)},s.onerror=t=>{r("failed to query DownloadsDB for ".concat(e,": ").concat(t.target.errorCode))}}),o=await s;if(null!==o)return o}var c=await l(e,t);let i=r.result.transaction(["downloads"],"readwrite"),u=new Promise((t,n)=>{i.oncomplete=e=>{t(null)},i.onerror=t=>{n(new Error("transaction error for saving ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}}),f=i.objectStore("downloads"),m=new Promise((t,n)=>{var r=f.put({url:e,payload:c});r.onsuccess=e=>{t(!0)},r.onerror=t=>{n(new Error("failed to cache ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}});return await m,await u,c}var i=n(8166),u=n(519);const f="https://cors-proxy.aaron-lun.workers.dev";async function m(e){let t=await c(f+"/"+encodeURIComponent(e));return new Uint8Array(t)}function d(e,t){if(e)if(Array.isArray(e))for(const n of e)d(n,t);else if(e.constructor==Object)for(const[n,r]of Object.entries(e))d(r,t);else if(ArrayBuffer.isView(e)){if(!(e.buffer instanceof ArrayBuffer))throw"only ArrayBuffers should be in the message payload";t.push(e.buffer)}}function p(e){postMessage({type:"".concat(e,"_START")})}function y(e,t){if("undefined"==typeof t)postMessage({type:"".concat(e,"_CACHE")});else{var n=[];d(t,n),postMessage({type:"".concat(e,"_DATA"),resp:t},n)}}function h(e,t,n){postMessage({type:"".concat(e,"_ERROR"),resp:{reason:t.toString(),fatal:n}})}function g(e){return Array.isArray(e)||ArrayBuffer.isView(e)}function w(e){let t,{all:n=!1,unique:r=!1,colname:o=null}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(g(e)){t=s.hp(e);const a=new Set(e);t.num_unique=a.size,a.size<=50&r&&(t.values=[...a].sort()),n&&(t._all_=e),"continuous"===t.type&&a.size<=50&&(t.type="both"),("string"===typeof o||o instanceof String)&&(t.name=o)}return t}function S(e,t,n){var r;n&&void 0!==n||(n="cohen-min-rank");{let o,a,l=!1;if(n.match(/-mean$/))o="mean";else if(n.match(/-min$/))o="minimum";else{if(!n.match(/-min-rank$/))throw"unknown rank type '"+n+"'";o="min-rank",l=!0}if(n.match(/^cohen-/))a=e.cohensD(t,{summary:o,copy:!1});else if(n.match(/^auc-/))a=e.auc(t,{summary:o,copy:!1});else if(n.match(/^lfc-/))a=e.deltaMean(t,{summary:o,copy:!1});else{if(!n.match(/^delta-d-/))throw"unknown rank type '"+n+"'";a=e.deltaDetected(t,{summary:o,copy:!1})}r=new Int32Array(a.length);for(var s=0;s<r.length;s++)r[s]=s;l?r.sort((e,t)=>a[e]-a[t]):r.sort((e,t)=>a[t]-a[e])}var o=function(e){for(var t=new Float64Array(e.length),n=0;n<r.length;n++)t[n]=e[r[n]];return t},a=o(e.mean(t,{copy:!1})),l=o(e.detected(t,{copy:!1})),c=o(e.deltaMean(t,{summary:"mean",copy:!1})),i=o(e.deltaDetected(t,{summary:"mean",copy:!1}));return{ordering:r,means:a,detected:l,lfc:c,delta_detected:i}}s.Ug.setDownload(m),i.Iy(m),s.Zx.setDownload(m),i.uN(async(e,t,n)=>{let r=i.Az()+"/"+e,s=f+"/"+encodeURIComponent(r);if(null==t&&null==n){let e=await c(s);return new Response(e)}return fetch(s+"?start="+String(t)+"&end="+String(n))}),i.iC(async e=>{let t=i.oc()+"/"+e,n=await c(f+"/"+encodeURIComponent(t));return new Response(n)}),u.az.setDownloadFun(m),s.uw.ExperimentHub=u.az,s.uw.gypsum=u.az;n(4080);const O="K@\ud835\udf02a#$c3ll";"".concat(O,"::CLUSTERS"),"".concat(O,"::SELECTION"),"".concat(O,"::CLUSTERS");const _="".concat(O,"::SELECTION");let v=null,E={},b={},R=null,A={},M=null,C=null,D=null;function k(e){let t,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if("H5AD"===e.format)t=new s.U4(e.h5);else if("SummarizedExperiment"===e.format)t=new s.o5(e.rds);else{if("ZippedArtifactdb"!==e.format)throw new Error("unknown format '"+e.format+"'");{let n=new s.VM(e.zipfile);t=e.ziplegacy?new s.m0(e.zipname,n):new s.J9(e.zipname,n)}}return n&&t.setOptions(e.options),t}function T(e,t){let n={};for(const s of e.cells.columnNames()){const t=e.cells.column(s);g(t)&&(n[s]=w(t,{all:!0,colname:s}))}let r={cells:{columns:n,numberOfCells:e.cells.numberOfRows()}};if("SummarizedExperiment"===t.format||"ZippedArtifactdb"===t.format){if(r.modality_features={},"modality_features"in e)for(const[s,o]of Object.entries(e.modality_features)){let e={};for(const t of o.columnNames()){const n=o.column(t);g(n)&&(e[t]=w(n,{all:!0,colname:t}))}r.modality_features[s]={columns:e,numberOfFeatures:o.numberOfRows(),rownames:Array.isArray(o.rowNames())}}}else{r.all_features={};let t={};for(const n of e.all_features.columnNames()){const r=e.all_features.column(n);g(r)&&(t[n]=w(r,{all:!0,colname:n}))}r.all_features={columns:t,numberOfFeatures:e.all_features.numberOfRows(),rownames:Array.isArray(e.all_features.rowNames())}}return"H5AD"===t.format?r.all_assay_names=e.all_assay_names:"SummarizedExperiment"!==t.format&&"ZippedArtifactdb"!==t.format||(r.modality_assay_names=e.modality_assay_names),r.reduced_dimension_names=e.reduced_dimension_names,r}function x(e,t){let n;return e in A||(n=new s.Jk(F(),t.ids.slice()),n.computeAll(),A[e]=n),A[e]}const N=e=>{if(-1!==e.indexOf(":::")){let t=e.split(":::");return R.cells.column(t[0]).column(t[1])}return R.cells.column(e)},F=()=>R.matrix;var P;onmessage=function(e){const{type:t,payload:n}=e.data;let l=!1;if("INIT"===t){l=!0;let e=Math.round(2*navigator.hardwareConcurrency/3),n=s.n_({numberOfThreads:e}),o=n.then(()=>s.fc());o.then(e=>{v=e,postMessage({type:t,msg:"Success: analysis state created"})});let c=(null===a&&(a=new Promise((e,t)=>{(r=indexedDB.open("DownloadsDB",3)).onupgradeneeded=e=>{var t=e.target.result;try{t.deleteObjectStore("downloads")}catch(e){}t.createObjectStore("downloads",{keyPath:"url"})},r.onsuccess=()=>{e(null)},r.onerror=()=>{t("failed to initialize DownloadsDB")}})),a);c.then(e=>{postMessage({type:"DownloadsDB_store",resp:e,msg:"Success: DownloadsDB initialized"})}).catch(e=>{console.error(e),postMessage({type:"DownloadsDB_ERROR",msg:"Error: Cannot initialize DownloadsDB"})}),(P=Promise.all([n,o,c])).then(()=>{postMessage({type:t,msg:"Success: bakana initialized"})}).catch(e=>{console.error(e),h(t,e,l)})}else if("EXPLORE"===t)l=!0,P.then(async e=>{let t=n.inputs.files;if(null!==t){let e={};for(const[n,r]of Object.entries(t))"uid"in r&&r.uid in E&&(E[r.uid].clear(),delete E[n]),e[n]=k(r,!0),e[n].setOptions(r.options);for(const[n,r]of Object.entries(e)){R=await r.load();t[n];let e="inputs";p(e);let o={};for(const t of R.cells.columnNames()){let e=R.cells.column(t);if(g(e)){const n=w(e,{all:!1,unique:!0,colname:t});o[t]=n}}let a={annotations:o,genes:{},num_cells:R.cells.numberOfRows(),num_genes:{}};for(const[t,n]of Object.entries(R.features)){a.genes[t]={},a.num_genes[t]=n.numberOfRows();for(const e of n.columnNames()){let r=n.column(e);g(r)&&(a.genes[t][e]=r)}n.rowNames()&&(a.genes[t].rowNames=n.rowNames())}y(e,a);let l="embedding";p(l);let c={};for(const[t,n]of Object.entries(R.reduced_dimensions))"pca"!==t.toLowerCase()&&(c[t]={x:n[0].slice(),y:n[1].slice()});y(l,c),M&&M.free(),M=new s.g0(R.matrix)}}}).catch(e=>{console.error(e),h(t,e,l)});else if("PREFLIGHT_INPUT"===t)P.then(async e=>{let t={};try{let e={},r={};for(const[t,s]of Object.entries(n.inputs.files))if("uid"in s)s.uid in E||(E[s.uid]=k(s),b[s.uid]=await E[s.uid].summary()),e[t]=E[s.uid],r[t]=T(b[s.uid],s);else{let n=k(s);e[t]=n,r[t]=T(e[t],s)}t.status="SUCCESS",t.details=r}catch(r){console.error(r),t.status="ERROR",t.reason=r.toString()}postMessage({type:"PREFLIGHT_INPUT_DATA",resp:t,msg:"Success: PREFLIGHT_INPUT done"})}).catch(e=>{console.error(e),h(t,e,l)});else if("computeVersusClusters"===t)P.then(e=>{let t=n.rank_type,r=n.modality,s=n.annotation,a=o.K$(N(s)),l=x(s,a).computeVersus(a.levels.indexOf(n.left),a.levels.indexOf(n.right)),c=S(l.results[r],l.left,t);var i=[];d(c,i),postMessage({type:"computeVersusClusters",resp:c,msg:"Success: COMPUTE_VERSUS_CLUSTERS done"},i)}).catch(e=>{console.error(e),h(t,e,l)});else if("computeVersusSelections"===t)P.then(e=>{let t=n.rank_type,r=S(M.computeVersus(n.left,n.right).results[n.modality],n.left,t);var s=[];d(r,s),postMessage({type:"computeVersusSelections",resp:r,msg:"Success: COMPUTE_VERSUS_SELECTIONS done"},s)}).catch(e=>{console.error(e),h(t,e,l)});else if("getMarkersForCluster"===t)P.then(e=>{let t=n.cluster,r=n.rank_type,s=n.modality,a=n.annotation,l=o.K$(N(a)),c=S(x(a,l).fetchResults()[s],l.levels.indexOf(t),r);var i=[];d(c,i),postMessage({type:"setMarkersForCluster",resp:c,msg:"Success: GET_MARKER_GENE done"},i)}).catch(e=>{console.error(e),h(t,e,l)});else if("getGeneExpression"===t)P.then(e=>{let t=n.gene,r=n.modality;var s=R.matrix.get(r).row(t);postMessage({type:"setGeneExpression",resp:{gene:t,expr:s},msg:"Success: GET_GENE_EXPRESSION done"},[s.buffer])}).catch(e=>{console.error(e),h(t,e,l)});else if("computeCustomMarkers"===t)P.then(e=>{M.addSelection(n.id,n.selection),postMessage({type:"computeCustomMarkers",msg:"Success: COMPUTE_CUSTOM_MARKERS done"})}).catch(e=>{console.error(e),h(t,e,l)});else if("getMarkersForSelection"===t)P.then(e=>{let t=n.rank_type,r=S(M.fetchResults(n.cluster)[n.modality],1,t);var s=[];d(r,s),postMessage({type:"setMarkersForCustomSelection",resp:r,msg:"Success: GET_MARKER_GENE done"},s)}).catch(e=>{console.error(e),h(t,e,l)});else if("removeCustomMarkers"===t)P.then(e=>{M.removeSelection(n.id)}).catch(e=>{console.error(e),h(t,e,l)});else if("getAnnotation"===t)P.then(e=>{let t,r,s=n.annotation;if(t=N(s),ArrayBuffer.isView(t))r={type:"array",values:t.slice()};else{let e=[],n={},s=new Int32Array(t.length);t.map((t,r)=>{t in n||(n[t]=e.length,e.push(t)),s[r]=n[t]}),r={type:"factor",index:s,levels:e}}let o=[];d(r,o),postMessage({type:"setAnnotation",resp:{annotation:s,values:r},msg:"Success: GET_ANNOTATION done"},o)}).catch(e=>{console.error(e),h(t,e,l)});else if("computeFeaturesetSummary"===t)P.then(async e=>{let t,{annotation:r,rank_type:s,cluster:a,modality:l}=n,c=s.indexOf("-");if(_===r){let e=M.fetchResults(a)[l];C.ready().then(n=>{t=C.computeEnrichment(e,1,s.slice(0,c),s.slice(c+1)),y("computeFeaturesetSummary",t)})}else{let e=o.K$(N(r)),n=x(r,e).fetchResults()[l];C.ready().then(r=>{t=C.computeEnrichment(n,e.levels.indexOf(a),s.slice(0,c),s.slice(c+1)),y("computeFeaturesetSummary",t)})}}).catch(e=>{console.error(e),h(t,e,l)});else if("computeFeaturesetVSSummary"===t)P.then(async e=>{let t,{annotation:r,rank_type:s,left:a,right:l,modality:c}=n,i=s.indexOf("-");if(_===r){let e=M.computeVersus(a,l);C.ready().then(n=>{t=C.computeEnrichment(e.results[c],0,s.slice(0,i),s.slice(i+1)),y("computeFeaturesetVSSummary",t)})}else{let e=o.K$(N(r)),a=x(r,e).computeVersus(e.levels.indexOf(n.left),e.levels.indexOf(n.right));C.ready().then(e=>{t=C.computeEnrichment(a.results[c],a.left,s.slice(0,i),s.slice(i+1)),y("computeFeaturesetVSSummary",t)})}}).catch(e=>{console.error(e),h(t,e,l)});else if("getFeatureScores"===t)P.then(e=>{let{index:t}=n;y("setFeatureScores",C.computePerCellScores(t))}).catch(e=>{console.error(e),h(t,e,l)});else if("getFeatureGeneIndices"===t)P.then(e=>{let t,r,{index:s,cluster:a,annotation:l,modality:c,rank_type:i}=n,u=C.fetchFeatureSetIndices(s);if(_===l)t=M.fetchResults(n.cluster)[n.modality],r=S(t,1,n.rank_type);else{let e=o.K$(N(l));t=x(l,e).fetchResults()[c],r=S(t,e.levels.indexOf(a),i)}let f=r.ordering.map((e,t)=>u.includes(e)?t:-100).filter(e=>-100!==e),m={};for(const[n,o]of Object.entries(r))m[n]=o.map((e,t)=>f.includes(t)?e:-100).filter(e=>-100!==e);y("setFeatureGeneIndices",m)}).catch(e=>{console.error(e),h(t,e,l)});else if("initFeaturesetEnrich"===t)P.then(async e=>{let{modality:t}=n;C&&C.free(),C=new s.z7(R.features[t],{normalized:R.matrix.get(t)}),C.ready().then(e=>{let t=C.fetchCollectionDetails(),n=C.fetchSetDetails();y("feature_set_enrichment",{collections:t,sets:{names:n.names,descriptions:n.descriptions,sizes:n.sizes.slice(),collections:n.collections.slice()}})})});else if("computeCellAnnotation"===t){let{annotation:e,cluster:r,modality:a}=n,c={per_reference:{}},i=null;if(_===e)i=M.fetchResults(r);else{let t=x(e,o.K$(N(e)));i=t.fetchResults()}null!==i&&a in i&&(null===D&&(D=new s.qJ(R.features[a])),D.ready().then(()=>{c=D.computeLabels(i[a]),y("computeCellAnnotation",c)}).catch(e=>{console.error(e),h(t,e,l)}))}else console.error("MIM:::msg type incorrect"),h(t,"Type not defined",l)}}},t={};function n(r){var s=t[r];if(void 0!==s)return s.exports;var o=t[r]={id:r,loaded:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}n.m=e,n.x=()=>{var e=n.O(void 0,[691,985,522],()=>n(2418));return e=n.O(e)},(()=>{var e=[];n.O=(t,r,s,o)=>{if(!r){var a=1/0;for(u=0;u<e.length;u++){for(var[r,s,o]=e[u],l=!0,c=0;c<r.length;c++)(!1&o||a>=o)&&Object.keys(n.O).every(e=>n.O[e](r[c]))?r.splice(c--,1):(l=!1,o<a&&(a=o));if(l){e.splice(u--,1);var i=s();void 0!==i&&(t=i)}}return t}o=o||0;for(var u=e.length;u>0&&e[u-1][2]>o;u--)e[u]=e[u-1];e[u]=[r,s,o]}})(),n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce((t,r)=>(n.f[r](e,t),t),[])),n.u=e=>"static/js/"+e+"."+{120:"568b3440",343:"07177662",522:"44959ef0",691:"9a33b0ff",814:"bc231a0d",985:"b0e597fb"}[e]+".chunk.js",n.miniCssF=e=>{},n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),n.p="/kana/",(()=>{n.b=self.location+"/../../../";var e={418:1};n.f.i=(t,r)=>{e[t]||importScripts(n.p+n.u(t))};var t=self.webpackChunkkana=self.webpackChunkkana||[],r=t.push.bind(t);t.push=t=>{var[s,o,a]=t;for(var l in o)n.o(o,l)&&(n.m[l]=o[l]);for(a&&a(n);s.length;)e[s.pop()]=1;r(t)}})(),(()=>{var e=n.x;n.x=()=>Promise.all([691,985,522].map(n.e,n)).then(e)})();n.x()})();
//# sourceMappingURL=418.324af429.chunk.js.map