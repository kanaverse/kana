(()=>{"use strict";var e={9747:(e,t,s)=>{var n,r=s(797),o=s(5831),a=null;async function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(await a,!s){let t=n.result.transaction(["downloads"],"readonly").objectStore("downloads");var r=new Promise(((s,n)=>{var r=t.get(e);r.onsuccess=e=>{void 0!==r.result?s(r.result.payload):s(null)},r.onerror=t=>{n("failed to query DownloadsDB for ".concat(e,": ").concat(t.target.errorCode))}})),o=await r;if(null!==o)return o}var l;l=null==t?fetch(e):fetch(e,t);var c=await l;if(!c.ok)throw new Error("failed to download '"+e+"' ("+c.status+")");var i=await c.arrayBuffer();let u=n.result.transaction(["downloads"],"readwrite"),f=new Promise(((t,s)=>{u.oncomplete=e=>{t(null)},u.onerror=t=>{s(new Error("transaction error for saving ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}})),m=u.objectStore("downloads"),d=new Promise(((t,s)=>{var n=m.put({url:e,payload:i});n.onsuccess=e=>{t(!0)},n.onerror=t=>{s(new Error("failed to cache ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}}));return await d,await f,i}var c=s(7325),i=s(6418);const u="https://cors-proxy.aaron-lun.workers.dev";async function f(e){let t=await l(u+"/"+encodeURIComponent(e));return new Uint8Array(t)}function m(e,t){if(e)if(Array.isArray(e))for(const s of e)m(s,t);else if(e.constructor==Object)for(const[s,n]of Object.entries(e))m(n,t);else if(ArrayBuffer.isView(e)){if(!(e.buffer instanceof ArrayBuffer))throw"only ArrayBuffers should be in the message payload";t.push(e.buffer)}}function d(e){postMessage({type:"".concat(e,"_START")})}function p(e,t){if("undefined"==typeof t)postMessage({type:"".concat(e,"_CACHE")});else{var s=[];m(t,s),postMessage({type:"".concat(e,"_DATA"),resp:t},s)}}function y(e,t,s){postMessage({type:"".concat(e,"_ERROR"),resp:{reason:t.toString(),fatal:s}})}function h(e){return Array.isArray(e)||ArrayBuffer.isView(e)}function w(e){let t,{all:s=!1,unique:n=!1,colname:o=null}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(h(e)){t=r.Qr(e);const a=new Set(e);t.num_unique=a.size,a.size<=50&n&&(t.values=[...a].sort()),s&&(t._all_=e),"continuous"===t.type&&a.size<=50&&(t.type="both"),("string"===typeof o||o instanceof String)&&(t.name=o)}return t}r.ES.setDownload(f),c.b5(f),r.E4.setDownload(f),c.ao((async(e,t,s)=>{let n=c.XZ()+"/"+e,r=u+"/"+encodeURIComponent(n);if(null==t&&null==s){let e=await l(r);return new Response(e)}return fetch(r+"?start="+String(t)+"&end="+String(s))})),c.d9((async e=>{let t=c.Kk()+"/"+e,s=await l(u+"/"+encodeURIComponent(t));return new Response(s)})),i.M.setDownloadFun(f),r.cO.ExperimentHub=i.M;s(3841);const g="K@\ud835\udf02a#$c3ll";"".concat(g,"::CLUSTERS"),"".concat(g,"::SELECTION"),"".concat(g,"::CLUSTERS");const S="".concat(g,"::SELECTION");let _=null,E={},v={},O=null,b={},R=null,C=null,x=null;function A(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if("H5AD"===e.format)return new r.nN(e.h5,t?e.options:{});if("SummarizedExperiment"===e.format)return new r.CM(e.rds,t?e.options:{});if("ZippedArtifactdb"===e.format)return new r.EQ(e.zipname,new r.zD(e.zipfile),t?e.options:{});throw new Error("unknown format '"+e.format+"'")}function M(e,t){let s={};for(const r of e.cells.columnNames()){const t=e.cells.column(r);h(t)&&(s[r]=w(t,{all:!0,colname:r}))}let n={cells:{columns:s,numberOfCells:e.cells.numberOfRows()}};if("SummarizedExperiment"===t.format||"ZippedArtifactdb"===t.format){if(n.modality_features={},"modality_features"in e)for(const[r,o]of Object.entries(e.modality_features)){let e={};for(const t of o.columnNames()){const s=o.column(t);h(s)&&(e[t]=w(s,{all:!0,colname:t}))}n.modality_features[r]={columns:e,numberOfFeatures:o.numberOfRows(),rownames:Array.isArray(o.rowNames())}}}else{n.all_features={};let t={};for(const s of e.all_features.columnNames()){const n=e.all_features.column(s);h(n)&&(t[s]=w(n,{all:!0,colname:s}))}n.all_features={columns:t,numberOfFeatures:e.all_features.numberOfRows(),rownames:Array.isArray(e.all_features.rowNames())}}return"H5AD"===t.format?n.all_assay_names=e.all_assay_names:"SummarizedExperiment"!==t.format&&"ZippedArtifactdb"!==t.format||(n.modality_assay_names=e.modality_assay_names),n.reduced_dimension_names=e.reduced_dimension_names,n}function T(e,t){let s;return e in b||(s=new r.J6(D(),t.ids.slice()),s.computeAll(),b[e]=s),b[e]}const k=e=>{if(-1!==e.indexOf(":::")){let t=e.split(":::");return O.cells.column(t[0]).column(t[1])}return O.cells.column(e)},D=()=>O.matrix;var j;onmessage=function(e){const{type:t,payload:s}=e.data;let l=!1;if("INIT"===t){l=!0;let e=Math.round(2*navigator.hardwareConcurrency/3),s=r.j2({numberOfThreads:e}),o=s.then((()=>r.TN()));o.then((e=>{_=e,postMessage({type:t,msg:"Success: analysis state created"})}));let c=(null===a&&(a=new Promise(((e,t)=>{(n=indexedDB.open("DownloadsDB",3)).onupgradeneeded=e=>{var t=e.target.result;try{t.deleteObjectStore("downloads")}catch(e){}t.createObjectStore("downloads",{keyPath:"url"})},n.onsuccess=()=>{e(null)},n.onerror=()=>{t("failed to initialize DownloadsDB")}}))),a);c.then((e=>{postMessage({type:"DownloadsDB_store",resp:e,msg:"Success: DownloadsDB initialized"})})).catch((e=>{console.error(e),postMessage({type:"DownloadsDB_ERROR",msg:"Error: Cannot initialize DownloadsDB"})})),(j=Promise.all([s,o,c])).then((()=>{postMessage({type:t,msg:"Success: bakana initialized"})})).catch((e=>{console.error(e),y(t,e,l)}))}else if("EXPLORE"===t)l=!0,j.then((async e=>{let t=s.inputs.files;if(null!==t){let e={};for(const[s,n]of Object.entries(t))"uid"in n&&n.uid in E&&(E[n.uid].clear(),delete E[s]),e[s]=A(n,!0),e[s].setOptions(n.options);for(const[s,n]of Object.entries(e)){O=await n.load();t[s];let e="inputs";d(e);let o={};for(const t of O.cells.columnNames()){let e=O.cells.column(t);if(h(e)){const s=w(e,{all:!1,unique:!0,colname:t});o[t]=s}}let a={annotations:o,genes:{},num_cells:O.cells.numberOfRows(),num_genes:{}};for(const[t,s]of Object.entries(O.features)){a.genes[t]={},a.num_genes[t]=s.numberOfRows();for(const e of s.columnNames()){let n=s.column(e);h(n)&&(a.genes[t][e]=n)}s.rowNames()&&(a.genes[t].rowNames=s.rowNames())}p(e,a);let l="embedding";d(l);let c={};for(const[t,s]of Object.entries(O.reduced_dimensions))"pca"!==t.toLowerCase()&&(c[t]={x:s[0].slice(),y:s[1].slice()});p(l,c),R&&R.free(),R=new r.sF(O.matrix)}}})).catch((e=>{console.error(e),y(t,e,l)}));else if("PREFLIGHT_INPUT"===t)j.then((async e=>{let t={};try{let e={},n={};for(const[t,r]of Object.entries(s.inputs.files))if("uid"in r)r.uid in E||(E[r.uid]=A(r),v[r.uid]=await E[r.uid].summary()),e[t]=E[r.uid],n[t]=M(v[r.uid],r);else{let s=A(r);e[t]=s,n[t]=M(e[t],r)}t.status="SUCCESS",t.details=n}catch(n){console.error(n),t.status="ERROR",t.reason=n.toString()}postMessage({type:"PREFLIGHT_INPUT_DATA",resp:t,msg:"Success: PREFLIGHT_INPUT done"})})).catch((e=>{console.error(e),y(t,e,l)}));else if("computeVersusClusters"===t)j.then((e=>{let t=s.rank_type,n=s.modality,a=s.annotation,l=o.Yh(k(a)),c=T(a,l).computeVersus(l.levels.indexOf(s.left),l.levels.indexOf(s.right)),i=r.jJ(c.results[n],c.left,t);var u=[];m(i,u),postMessage({type:"computeVersusClusters",resp:i,msg:"Success: COMPUTE_VERSUS_CLUSTERS done"},u)})).catch((e=>{console.error(e),y(t,e,l)}));else if("computeVersusSelections"===t)j.then((e=>{let t=s.rank_type,n=R.computeVersus(s.left,s.right),o=r.jJ(n.results[s.modality],s.left,t);var a=[];m(o,a),postMessage({type:"computeVersusSelections",resp:o,msg:"Success: COMPUTE_VERSUS_SELECTIONS done"},a)})).catch((e=>{console.error(e),y(t,e,l)}));else if("getMarkersForCluster"===t)j.then((e=>{let t=s.cluster,n=s.rank_type,a=s.modality,l=s.annotation,c=o.Yh(k(l)),i=T(l,c).fetchResults()[a],u=r.jJ(i,c.levels.indexOf(t),n);var f=[];m(u,f),postMessage({type:"setMarkersForCluster",resp:u,msg:"Success: GET_MARKER_GENE done"},f)})).catch((e=>{console.error(e),y(t,e,l)}));else if("getGeneExpression"===t)j.then((e=>{let t=s.gene,n=s.modality;var r=O.matrix.get(n).row(t);postMessage({type:"setGeneExpression",resp:{gene:t,expr:r},msg:"Success: GET_GENE_EXPRESSION done"},[r.buffer])})).catch((e=>{console.error(e),y(t,e,l)}));else if("computeCustomMarkers"===t)j.then((e=>{R.addSelection(s.id,s.selection),postMessage({type:"computeCustomMarkers",msg:"Success: COMPUTE_CUSTOM_MARKERS done"})})).catch((e=>{console.error(e),y(t,e,l)}));else if("getMarkersForSelection"===t)j.then((e=>{let t=s.rank_type,n=R.fetchResults(s.cluster)[s.modality],o=r.jJ(n,1,t);var a=[];m(o,a),postMessage({type:"setMarkersForCustomSelection",resp:o,msg:"Success: GET_MARKER_GENE done"},a)})).catch((e=>{console.error(e),y(t,e,l)}));else if("removeCustomMarkers"===t)j.then((e=>{R.removeSelection(s.id)})).catch((e=>{console.error(e),y(t,e,l)}));else if("getAnnotation"===t)j.then((e=>{let t,n,r=s.annotation;if(t=k(r),ArrayBuffer.isView(t))n={type:"array",values:t.slice()};else{let e=[],s={},r=new Int32Array(t.length);t.map(((t,n)=>{t in s||(s[t]=e.length,e.push(t)),r[n]=s[t]})),n={type:"factor",index:r,levels:e}}let o=[];m(n,o),postMessage({type:"setAnnotation",resp:{annotation:r,values:n},msg:"Success: GET_ANNOTATION done"},o)})).catch((e=>{console.error(e),y(t,e,l)}));else if("computeFeaturesetSummary"===t)j.then((async e=>{let t,{annotation:n,rank_type:r,cluster:a,modality:l}=s,c=r.indexOf("-");if(S===n){let e=R.fetchResults(a)[l];C.ready().then((s=>{t=C.computeEnrichment(e,1,r.slice(0,c),r.slice(c+1)),p("computeFeaturesetSummary",t)}))}else{let e=o.Yh(k(n)),s=T(n,e).fetchResults()[l];C.ready().then((n=>{t=C.computeEnrichment(s,e.levels.indexOf(a),r.slice(0,c),r.slice(c+1)),p("computeFeaturesetSummary",t)}))}})).catch((e=>{console.error(e),y(t,e,l)}));else if("computeFeaturesetVSSummary"===t)j.then((async e=>{let t,{annotation:n,rank_type:r,left:a,right:l,modality:c}=s,i=r.indexOf("-");if(S===n){let e=R.computeVersus(a,l);C.ready().then((s=>{t=C.computeEnrichment(e.results[c],0,r.slice(0,i),r.slice(i+1)),p("computeFeaturesetVSSummary",t)}))}else{let e=o.Yh(k(n)),a=T(n,e).computeVersus(e.levels.indexOf(s.left),e.levels.indexOf(s.right));C.ready().then((e=>{t=C.computeEnrichment(a.results[c],a.left,r.slice(0,i),r.slice(i+1)),p("computeFeaturesetVSSummary",t)}))}})).catch((e=>{console.error(e),y(t,e,l)}));else if("getFeatureScores"===t)j.then((e=>{let{index:t}=s;p("setFeatureScores",C.computePerCellScores(t))})).catch((e=>{console.error(e),y(t,e,l)}));else if("getFeatureGeneIndices"===t)j.then((e=>{let t,n,{index:a,cluster:l,annotation:c,modality:i,rank_type:u}=s,f=C.fetchFeatureSetIndices(a);if(S===c)t=R.fetchResults(s.cluster)[s.modality],n=r.jJ(t,1,s.rank_type);else{let e=o.Yh(k(c));t=T(c,e).fetchResults()[i],n=r.jJ(t,e.levels.indexOf(l),u)}let m=n.ordering.map(((e,t)=>f.includes(e)?t:-100)).filter((e=>-100!==e)),d={};for(const[s,r]of Object.entries(n))d[s]=r.map(((e,t)=>m.includes(t)?e:-100)).filter((e=>-100!==e));p("setFeatureGeneIndices",d)})).catch((e=>{console.error(e),y(t,e,l)}));else if("initFeaturesetEnrich"===t)j.then((async e=>{let{modality:t}=s;C&&C.free(),C=new r.Y(O.features[t],{normalized:O.matrix.get(t)}),C.ready().then((e=>{let t=C.fetchCollectionDetails(),s=C.fetchSetDetails();p("feature_set_enrichment",{collections:t,sets:{names:s.names,descriptions:s.descriptions,sizes:s.sizes.slice(),collections:s.collections.slice()}})}))}));else if("computeCellAnnotation"===t){let{annotation:e,cluster:n,modality:a}=s,c={per_reference:{}},i=null;if(S===e)i=R.fetchResults(n);else{let t=T(e,o.Yh(k(e)));i=t.fetchResults()}null!==i&&a in i&&(null===x&&(x=new r.rV(O.features[a])),x.ready().then((()=>{c=x.computeLabels(i[a]),p("computeCellAnnotation",c)})).catch((e=>{console.error(e),y(t,e,l)})))}else console.error("MIM:::msg type incorrect"),y(t,"Type not defined",l)}}},t={};function s(n){var r=t[n];if(void 0!==r)return r.exports;var o=t[n]={id:n,loaded:!1,exports:{}};return e[n].call(o.exports,o,o.exports,s),o.loaded=!0,o.exports}s.m=e,s.x=()=>{var e=s.O(void 0,[86,477,463],(()=>s(9747)));return e=s.O(e)},(()=>{var e=[];s.O=(t,n,r,o)=>{if(!n){var a=1/0;for(u=0;u<e.length;u++){n=e[u][0],r=e[u][1],o=e[u][2];for(var l=!0,c=0;c<n.length;c++)(!1&o||a>=o)&&Object.keys(s.O).every((e=>s.O[e](n[c])))?n.splice(c--,1):(l=!1,o<a&&(a=o));if(l){e.splice(u--,1);var i=r();void 0!==i&&(t=i)}}return t}o=o||0;for(var u=e.length;u>0&&e[u-1][2]>o;u--)e[u]=e[u-1];e[u]=[n,r,o]}})(),s.d=(e,t)=>{for(var n in t)s.o(t,n)&&!s.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},s.f={},s.e=e=>Promise.all(Object.keys(s.f).reduce(((t,n)=>(s.f[n](e,t),t)),[])),s.u=e=>"static/js/"+e+"."+{86:"ac3d5bbd",463:"7ff8fc8b",477:"ad1d02d7",484:"3a78824a",909:"5e5ec0f8",933:"593da312"}[e]+".chunk.js",s.miniCssF=e=>{},s.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}(),s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),s.p="/kana/",(()=>{s.b=self.location+"/../../../";var e={747:1};s.f.i=(t,n)=>{e[t]||importScripts(s.p+s.u(t))};var t=self.webpackChunkkana=self.webpackChunkkana||[],n=t.push.bind(t);t.push=t=>{var r=t[0],o=t[1],a=t[2];for(var l in o)s.o(o,l)&&(s.m[l]=o[l]);for(a&&a(s);r.length;)e[r.pop()]=1;n(t)}})(),(()=>{var e=s.x;s.x=()=>Promise.all([86,477,463].map(s.e,s)).then(e)})();s.x()})();
//# sourceMappingURL=747.c79fa4ad.chunk.js.map