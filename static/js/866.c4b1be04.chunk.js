(()=>{"use strict";var e={2866:(e,t,r)=>{var n,s=r(1522),o=r(7990),a=null;function i(){var e=n.result.transaction(["analysis_meta"],"readonly").objectStore("analysis_meta").getAll();return new Promise(((t,r)=>{e.onsuccess=r=>{let n=e.result;n.forEach((e=>{delete e.files})),t(n)},e.onerror=e=>{r(new Error("failed to query the analysis store in KanaDB: ".concat(e.target.errorCode)))}}))}async function l(){return await a,i()}async function c(e){await a;let t=n.result.transaction(["file"],"readonly").objectStore("file"),r=new Promise(((r,n)=>{let s=t.get(e);s.onsuccess=e=>{r(void 0!==s.result?s.result:null)},s.onerror=t=>{n(new Error("failed to retrieve file ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}}));var s=await r;return null!==s&&(s=new Uint8Array(s.payload)),s}async function u(e){let t=await e;if(t instanceof Array){let e=[];for(const r of t)e.push(await u(r));t=e}return t}function f(e,t,r){let n=r.get(e);return new Promise(((s,o)=>{n.onsuccess=o=>{let a=n.result;var i=a.count-1,l=[];0===i?(l.push(new Promise(((r,n)=>{let s=t.delete(e);s.onsuccess=e=>{r(!0)},s.onerror=t=>{n(new Error("failed to remove file ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}}))),l.push(new Promise(((t,n)=>{let s=r.delete(e);s.onsuccess=e=>{t(!0)},s.onerror=t=>{n(new Error("failed to remove file metadata ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}})))):l.push(new Promise(((t,n)=>{a.count=i;let s=r.put(a);s.onsuccess=e=>{t(!0)},s.onerror=t=>{n(new Error("failed to update file metadata ".concat(e," in KanaDB: ").concat(t.target.errorCode)))}}))),s(l)},n.onerror=t=>{o(new Error("failed to retrieve file metadata ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}}))}var d,m=r(8166),p=r(4441),h=r(9757),y=null;async function w(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;try{const r=await async function(e,t,r,n){let s,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if(s=null==o?await fetch(e):await fetch(e,o),!s.ok)throw new Error("oops, failed to download '"+e+"'");const a=t(s.headers.get("content-length")),i=s.body.getReader(),l=[];let c=0;for(;;){const{done:e,value:t}=await i.read();if(e)break;l.push(t),c+=t.length,r(a,c)}let u=new Uint8Array(c),f=0;for(const d of l)u.set(d,f),f+=d.length;return n(a,c),u}(e,(t=>(postMessage({type:"DOWNLOAD for url: "+String(e),download:"START",url:String(e),total_bytes:String(t),msg:"Total size is "+String(t)+" bytes!"}),e)),((t,r)=>{postMessage({type:"DOWNLOAD for url: "+String(e),download:"PROGRESS",url:String(e),downloaded_bytes:String(r),msg:"Progress so far, got "+String(r)+" bytes!"})}),((t,r)=>{postMessage({type:"DOWNLOAD for url: "+String(e),download:"COMPLETE",url:String(e),msg:"Finished, got "+String(r)+" bytes!"})}),t);return r}catch(s){let o;postMessage({type:"DOWNLOAD for url: "+String(e),download:"START",url:String(e),total_bytes:100}),o=null==t?fetch(e):fetch(e,t);var r=await o;if(!r.ok)throw new Error("failed to download '"+e+"' ("+r.status+")");var n=await r.arrayBuffer();return postMessage({type:"DOWNLOAD for url: "+String(e),download:"COMPLETE",url:String(e)}),new Uint8Array(n)}}async function g(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(await y,!r){let t=d.result.transaction(["downloads"],"readonly").objectStore("downloads");var n=new Promise(((r,n)=>{var s=t.get(e);s.onsuccess=e=>{void 0!==s.result?r(s.result.payload):r(null)},s.onerror=t=>{n("failed to query DownloadsDB for ".concat(e,": ").concat(t.target.errorCode))}})),s=await n;if(null!==s)return s}var o=await w(e,t);let a=d.result.transaction(["downloads"],"readwrite"),i=new Promise(((t,r)=>{a.oncomplete=e=>{t(null)},a.onerror=t=>{r(new Error("transaction error for saving ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}})),l=a.objectStore("downloads"),c=new Promise(((t,r)=>{var n=l.put({url:e,payload:o});n.onsuccess=e=>{t(!0)},n.onerror=t=>{r(new Error("failed to cache ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}}));return await c,await i,o}var _=r(6159),S=r.n(_);const b="https://cors-proxy.aaron-lun.workers.dev";async function O(e){let t=await g(b+"/"+encodeURIComponent(e));return new Uint8Array(t)}function v(e,t){if(e)if(Array.isArray(e))for(const r of e)v(r,t);else if(e.constructor==Object)for(const[r,n]of Object.entries(e))v(n,t);else if(ArrayBuffer.isView(e)){if(!(e.buffer instanceof ArrayBuffer))throw"only ArrayBuffers should be in the message payload";t.push(e.buffer)}}function R(e){postMessage({type:"".concat(e,"_START")})}function E(e,t){if("undefined"==typeof t)postMessage({type:"".concat(e,"_CACHE")});else{var r=[];v(t,r),postMessage({type:"".concat(e,"_DATA"),resp:t},r)}}function A(e,t,r){postMessage({type:"".concat(e,"_ERROR"),resp:{reason:t.toString(),fatal:r}})}function D(e,t,r){for(var n={},s=r.slice(),o=0;o<t.length;o++){let r={};for(const[t,n]of Object.entries(e))r[t]=n.slice().filter(((e,t)=>s[t]==o));n[t[o]]=r}return n}function C(e,t){var r={};for(const s of t)r[s]={};for(const[s,o]of Object.entries(e))for(var n=0;n<t.length;n++)r[t[n]][s]=o[n];return r}function P(e){return Array.isArray(e)||ArrayBuffer.isView(e)}function M(e){let t,{all:r=!1,unique:n=!1,colname:o=null}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(P(e)){t=s.hp(e);const a=new Set(e);t.num_unique=a.size,a.size<=50&n&&(t.values=[...a].sort()),r&&(t._all_=e),"continuous"===t.type&&a.size<=50&&(t.type="both"),("string"===typeof o||o instanceof String)&&(t.name=o)}return t}s.Ug.setDownload(O),m.Iy(O),s.Zx.setDownload(O),m.uN((async(e,t,r)=>{let n=m.Az()+"/"+e,s=b+"/"+encodeURIComponent(n);if(null==t&&null==r){let e=await g(s);return new Response(e)}return fetch(s+"?start="+String(t)+"&end="+String(r))})),m.iC((async e=>{let t=m.oc()+"/"+e,r=await g(b+"/"+encodeURIComponent(t));return new Response(r)})),h.h.setDownloadFun(O),s.uw.ExperimentHub=h.h;r(4080);const k="K@\ud835\udf02a#$c3ll";"".concat(k,"::CLUSTERS"),"".concat(k,"::SELECTION");const T="".concat(k,"::CLUSTERS"),x="".concat(k,"::SELECTION");let B=null,N={},j={},F=null,I={};function L(e){if("10X"===e.format)return new s.Fp(e.h5,e.options?e.options:{});if("MatrixMarket"===e.format)return new s.f8(e.mtx,e.genes||null,e.annotations||null,e.options?e.options:{});if("H5AD"===e.format)return new s.F6(e.h5,e.options?e.options:{});if("SummarizedExperiment"===e.format)return new s.dn(e.rds,e.options?e.options:{});if("ZippedADB"===e.format)return new s.Pm(e.zipname,e.zipfile,e.options?e.options:{});if("ExperimentHub"===e.format)return new h.h(e.id,e.options?e.options:{});throw new Error("unknown format '"+e.format+"'")}function K(e,t){let r={};for(const s of e.cells.columnNames()){const t=e.cells.column(s);P(t)&&(r[s]=M(t,{all:!0,unique:!0,colname:s}))}let n={cells:{columns:r,numberOfCells:e.cells.numberOfRows()}};if("H5AD"===t.format){n.all_features={};let t={};for(const r of e.all_features.columnNames()){const n=e.all_features.column(r);P(n)&&(t[r]=M(n,{all:!0,unique:!0,colname:r}))}n.all_features={columns:t,numberOfFeatures:e.all_features.numberOfRows(),rownames:Array.isArray(e.all_features.rowNames())}}else if("SummarizedExperiment"===t.format){if(n.modality_features={},"modality_features"in e)for(const[s,o]of Object.entries(e.modality_features)){let e={};for(const t of o.columnNames()){const r=o.column(t);P(r)&&(e[t]=M(r,{all:!0,unique:!0,colname:t}))}n.modality_features[s]={columns:e,numberOfFeatures:o.numberOfRows(),rownames:Array.isArray(o.rowNames())}}}else if(n.modality_features={},"modality_features"in e)for(const[s,o]of Object.entries(e.modality_features)){let e={};for(const t of o.columnNames()){const r=o.column(t);P(r)&&(e[t]=M(r,{all:!0,unique:!0,colname:t}))}n.modality_features[s]={columns:e,numberOfFeatures:o.numberOfRows(),rownames:Array.isArray(o.rowNames())}}return"H5AD"===t.format?n.all_assay_names=e.all_assay_names:"SummarizedExperiment"!==t.format&&"ZippedADB"!==t.format||(n.modality_assay_names=e.modality_assay_names),n}async function z(e){try{let t=await async function(e,t){if(e[t].changed){if("inputs"===t){let r={},s={};for(const n of e[t].fetchCountMatrix().available())s[n]=e[t].fetchCountMatrix().get(n).numberOfRows();let o={};for(const[n,i]of Object.entries(e[t].fetchFeatureAnnotations())){let e={};for(const t of i.columnNames()){let r=i.column(t);Array.isArray(r)&&(e[t]=r)}Array.isArray(i.rowNames())&&(e.rownames=i.rowNames()),o[n]=e}let a={};for(const n of e[t].fetchCellAnnotations().columnNames()){let r=e[t].fetchCellAnnotations().column(n);if(P(r)){const e=M(r,{all:!1,unique:!0,colname:n});a[n]=e}}if(null!==(n=e[t].fetchBlockLevels())){const r=e[t].fetchBlock().slice();if(P(r)){const e=M(r,{all:!1,unique:!0,colname:"__batch__"});a.__batch__=e}}return r={num_cells:e[t].fetchCountMatrix().numberOfColumns(),num_genes:s,genes:o,annotations:a},r}if("rna_quality_control"===t){let r={sums:e[t].fetchMetrics().sums(),detected:e[t].fetchMetrics().detected(),proportion:e[t].fetchMetrics().subsetProportions(0)},s={};if(null===(n=e.inputs.fetchBlockLevels()))n=["default"],s.data={default:r};else{let t=e.inputs.fetchBlock();s.data=D(r,n,t)}let o={sums:e[t].fetchFilters().thresholdsSums(),detected:e[t].fetchFilters().thresholdsDetected(),proportion:e[t].fetchFilters().thresholdsSubsetProportions(0)};return s.thresholds=C(o,n),s}if("adt_quality_control"===t){let s={sums:e[t].fetchMetrics().sums(),detected:e[t].fetchMetrics().detected(),proportion:e[t].fetchMetrics().subsetTotals(0)};var r={};if(null===(n=e.inputs.fetchBlockLevels()))n=["default"],r.data={default:s};else{let t=e.inputs.fetchBlock();r.data=D(s,n,t)}let o={detected:e[t].fetchFilters().thresholdsDetected(),proportion:e[t].fetchFilters().thresholdsSubsetTotals(0)};r.thresholds=C(o,n);for(const[e,t]of Object.entries(r.thresholds))t.sums=NaN;return r}if("crispr_quality_control"===t){let r={sums:e[t].fetchMetrics().sums(),detected:e[t].fetchMetrics().detected(),proportion:e[t].fetchMetrics().maxProportions()},s={};var n;if(null===(n=e.inputs.fetchBlockLevels()))n=["default"],s.data={default:r};else{let t=e.inputs.fetchBlock();s.data=D(r,n,t)}let o={count:e[t].fetchFilters().thresholdsMaxCount(0)};return s.thresholds=C(o,n),s}if("cell_filtering"===t){let r=0,n=null;const s=e[t].fetchDiscards();return s?(s.forEach((e=>{r+=0==e})),n=s.slice()):r=e.inputs.fetchCountMatrix().numberOfColumns(),{retained:r,discard:n}}if("rna_normalization"===t)return{};if("adt_normalization"===t)return{};if("crispr_normalization"===t)return{};if("feature_selection"===t)return{means:e[t].fetchResults().means(),vars:e[t].fetchResults().variances(),fitted:e[t].fetchResults().fitted(),resids:e[t].fetchResults().residuals()};if("rna_pca"===t||"adt_pca"===t||"crispr_pca"===t){let r=e[t].fetchPCs();var s=r.varianceExplained(),o=r.totalVariance();return s.forEach(((e,t)=>{s[t]=e/o})),{var_exp:s}}if("combine_embeddings"===t)return{};if("batch_correction"===t)return{};if("neighbor_index"===t)return{};if("tsne"===t||"umap"===t)return await e[t].fetchResults();if("kmeans_cluster"===t)return{};if("snn_graph_cluster"===t)return{};if("choose_clustering"===t)return{clusters:e[t].fetchClusters().slice()};if("marker_detection"===t)return{};if("cell_labelling"===t){let r=e.marker_detection.fetchResults();return"RNA"in r?e[t].computeLabels(r.RNA):{per_reference:{}}}if("custom_selections"===t)return{};if("feature_set_enrichment"===t){let t=e.feature_set_enrichment.fetchCollectionDetails(),r=e.feature_set_enrichment.fetchSetDetails();return{collections:t,sets:{names:r.names,descriptions:r.descriptions,sizes:r.sizes.slice(),collections:r.collections.slice()}}}}}(B,e);E(e,t)}catch(t){console.error(t),A(e,t,!0)}}function G(e,t){let r;return e in I||(r=new s.Jk(V(),t.ids.slice()),r.computeAll(),I[e]=r),I[e]}s.cf(((e,t,r,n)=>{postMessage({type:e+"_iter",x:t,y:r,iteration:n},[t.buffer,r.buffer])})),s.v9(c);const U=function(e){let t,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if("__batch__"===e)t=B.inputs.fetchBlock().slice();else if(e.startsWith("".concat(k,"::QC::"))){let r=e.replace("".concat(k,"::QC::"),"").split("_"),n=B["".concat(r[0].toLowerCase(),"_quality_control")].fetchMetrics();"sums"===r[1]?t=n.sums():"detected"===r[1]?t=n.detected():"proportion"===r[1]&&("rna"===r[0].toLowerCase()?t=n.subsetProportions(0):"adt"===r[0].toLowerCase()?t=n.subsetTotals(0):"crispr"===r[0].toLowerCase()&&(t=n.maxProportions(0)))}else t=B.inputs.fetchCellAnnotations().column(e);return r||(t=B.cell_filtering.applyFilter(t)),t.slice()},V=()=>{if(null===F){F=new o.P_;let e={RNA:"rna_normalization",ADT:"adt_normalization",CRISPR:"crispr_normalization"};for(const[t,r]of Object.entries(e)){let e=B[r];e.valid()&&F.add(t,e.fetchNormalizedMatrix())}}return F};var H;onmessage=function(e){const{type:t,payload:r}=e.data;let w=!1;if("INIT"===t){w=!0;let e=Math.round(2*navigator.hardwareConcurrency/3),r=s.n_({numberOfThreads:e}),o=r.then((()=>s.fc()));o.then((e=>{B=e,postMessage({type:t,msg:"Success: analysis state created"})}));let l=a=new Promise((e=>{(n=indexedDB.open("KanaDB",2)).onupgradeneeded=e=>{var t=e.target.result;try{t.deleteObjectStore("analysis")}catch(e){}try{t.deleteObjectStore("analysis_meta")}catch(e){}try{t.deleteObjectStore("file")}catch(e){}try{t.deleteObjectStore("file_meta")}catch(e){}t.createObjectStore("analysis",{keyPath:"id"}),t.createObjectStore("analysis_meta",{keyPath:"id"}),t.createObjectStore("file",{keyPath:"id"}),t.createObjectStore("file_meta",{keyPath:"id"})},n.onsuccess=()=>{e(i())},n.onerror=()=>{e(null)}}));l.then((e=>{null!==e&&postMessage({type:"KanaDB_store",resp:e,msg:"Success: KanaDB initialized"})})).catch((e=>{console.error(e),postMessage({type:"KanaDB_ERROR",msg:"Error: Cannot initialize KanaDB"})}));let c=(null===y&&(y=new Promise(((e,t)=>{(d=indexedDB.open("DownloadsDB",3)).onupgradeneeded=e=>{var t=e.target.result;try{t.deleteObjectStore("downloads")}catch(e){}t.createObjectStore("downloads",{keyPath:"url"})},d.onsuccess=()=>{e(null)},d.onerror=()=>{t("failed to initialize DownloadsDB")}}))),y);c.then((e=>{postMessage({type:"DownloadsDB_store",resp:e,msg:"Success: DownloadsDB initialized"})})).catch((e=>{console.error(e),postMessage({type:"DownloadsDB_ERROR",msg:"Error: Cannot initialize DownloadsDB"})}));try{let e=h.h.availableDatasets();postMessage({type:"ExperimentHub_store",resp:e,msg:"Success: ExperimentHub initialized"})}catch(b){console.error(b),postMessage({type:"ExperimentHub_ERROR",msg:"Error: Cannot access datasets in ExperimentHub"})}(H=Promise.all([r,l,c,o])).then((()=>{postMessage({type:t,msg:"Success: bakana initialized"})})).catch((e=>{console.error(e),A(t,e,w)}))}else if("RUN"===t)w=!0,H.then((e=>{let n=r.inputs,o=n.files;if(null!==o){let e={};for(const[t,r]of Object.entries(o))"uid"in r&&r.uid in N?e[t]=N[r.uid]:e[t]=L(r),e[t].setOptions(r.options);for(const[t,r]of Object.entries(N))r.clear(),delete N[t];o=e}(()=>{for(const[e,t]of Object.entries(I))t.free();I={}})();let a=function(e,t){let r=t,n=(e,t,n)=>{if("undefined"==typeof n)throw new Error("cannot assign undefined parameter to '"+e+"."+t+"'");if(!(e in r))throw new Error("unknown analysis step '"+e+"'");let s=r[e];if(!(t in s))throw new Error("unknown analysis parameter '"+t+"' for step '"+e+"'");s[t]=n};n("inputs","block_factor",e.batch),n("inputs","subset",e.subset),s.nL(r,t.batch_correction.method),s.OD(r,t.neighbor_index.approximate),null!==r.combine_embeddings.weights&&new Set([r.combine_embeddings.rna_weight,r.combine_embeddings.adt_weight,r.combine_embeddings.crispr_weight]).size<=1&&(r.combine_embeddings.weights=null);return r}(n,r.params);s.A1(B,o,a,{startFun:R,finishFun:z}).catch((e=>{console.error(e),A(t,e,w)}))})).catch((e=>{console.error(e),A(t,e,w)}));else if("LOAD"===t){w=!0;let e=r.inputs.files;if("kana"===e[Object.keys(e)[0]].format){let r=e[Object.keys(e)[0]].file;H.then((async e=>{const t=(new FileReaderSync).readAsArrayBuffer(r),n=await S().loadAsync(t);let o=JSON.parse(await n.file("config.json").async("string")),a={};for(const r in n.files)if(r.startsWith("datasets/")){let e=await n.files[r].async("uint8array");a[r.split("/")[1]]=e}B=await s.SR(o,(e=>a[e]),{state:B,startFun:R,finishFun:z});const i={custom_selections:B.custom_selections.fetchSelections()};var l=[];v(o.parameters,l),postMessage({type:"loadedParameters",resp:{parameters:o.parameters,other:i}},l);let c={},u={};const f=B.inputs.fetchDatasets();for(const[r,s]of Object.entries(f)){let e=await s.previewPrimaryIds({cache:!0});for(const t of["RNA","ADT","CRISPR"])t in e&&(c[t]?c[t].push(e[t]):c[t]=[e[t]])}for(const[r,s]of Object.entries(c))u[r]=m.y$(s).length;postMessage({type:"PREFLIGHT_OPTIONS_DATA",resp:u,msg:"Success: PREFLIGHT_OPTIONS done"})})).catch((e=>{console.error(e),A(t,e,w)}))}else"kanadb"===e[Object.keys(e)[0]].format&&H.then((async t=>{var r=e[Object.keys(e)[0]].file;const o=await async function(e){await a;let t=n.result.transaction(["analysis"],"readonly").objectStore("analysis"),r=new Promise(((r,n)=>{let s=t.get(e);s.onsuccess=e=>{r(void 0!==s.result?s.result:null)},s.onerror=t=>{n(new Error("failed to retrieve analysis ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}}));var s=await r;return null!==s&&(s=new Uint8Array(s.payload)),s}(r),i=new TextDecoder;let l=JSON.parse(i.decode(o));B=await s.SR(l,c,{state:B,startFun:R,finishFun:z})})).catch((e=>{console.error(e),A(t,e,w)}))}else if("EXPORT"===t)H.then((async e=>{let t=[],r=await s.hO(B,((e,r,n)=>{let s=String(t.length);return t.push(n.buffer()),s}));const n=new(S());n.file("config.json",JSON.stringify(r));for(var o=0;o<t.length;o++)n.file("datasets/"+String(o),t[o]);let a=await n.generateAsync({type:"uint8array"});postMessage({type:"exportState",resp:a,msg:"Success: application state exported"},[a.buffer])})).catch((e=>{console.error(e),A(t,e,w)}));else if("EXPORT_RDS"===t)H.then((async e=>{let t=await s.JH(B,"sce",{forceBuffer:!0}),r=await s.DV(B,"",{forceBuffer:!0});for(const s of r)t.push(s);let n=await s.jG(t);postMessage({type:"exportRDSState",resp:n,msg:"Success: application state exported"},[n.buffer])})).catch((e=>{console.error(e),A(t,e,w)}));else if("SAVEKDB"===t){var g=r.title;H.then((async e=>{let r=[],o=await s.hO(B,(async(e,s,o)=>{let i=o.buffer();var l=await p.Fx(i),c=t+"_"+o.name()+"_"+i.length+"_"+l;return await async function(e,t){await a;let r=n.result.transaction(["file","file_meta"],"readwrite"),s=new Promise(((t,n)=>{r.oncomplete=e=>{t(null)},r.onerror=t=>{n(new Error("transaction error when saving file ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}})),o=r.objectStore("file"),i=r.objectStore("file_meta"),l=i.get(e),c=new Promise(((r,n)=>{l.onsuccess=n=>{let s=l.result;"undefined"===typeof s?s={count:1,id:e}:s.count++;var a=new Promise(((r,n)=>{var s=o.put({id:e,payload:t.buffer});s.onsuccess=e=>{r(!0)},s.onerror=t=>{n(new Error("failed to save file ".concat(e," in KanaDB: ").concat(t.target.errorCode)))}})),c=new Promise(((t,r)=>{var n=i.put(s);n.onsuccess=e=>{t(!0)},n.onerror=t=>{r(new Error("failed to save metadata for file ".concat(e," in KanaDB: ").concat(t.target.errorCode)))}}));r(Promise.all([a,c]))},l.onerror=t=>{n(new Error("failed to retrieve metadata ".concat(e," in KanaDB: ").concat(t.target.errorCode)))}}));await s,await c}(c,i),r.push(c),c}));let i=(new TextEncoder).encode(JSON.stringify(o)),c=await async function(e,t,r,s){await a;let o,i=n.result.transaction(["analysis","analysis_meta"],"readwrite"),l=new Promise(((t,r)=>{i.oncomplete=e=>{t(null)},i.onerror=t=>{r(new Error("transaction error when saving analysis ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}})),c=i.objectStore("analysis"),u=i.objectStore("analysis_meta"),f=e=>{var n=new Promise(((r,n)=>{var s=c.put({id:e,payload:t.buffer});s.onsuccess=e=>{r(!0)},s.onerror=t=>{n(new Error("failed to save analysis file ".concat(e," in KanaDB: ").concat(t.target.errorCode)))}})),o=new Promise(((t,n)=>{var o=u.put({id:e,files:r,time:Number(new Date),title:s});o.onsuccess=e=>{t(!0)},o.onerror=t=>{n(new Error("failed to save analysis metadata ".concat(e," in KanaDB: ").concat(t.target.errorCode)))}}));return[e,n,o]};if(null===e){let e=u.getAll();o=new Promise(((t,r)=>{e.onsuccess=r=>{t(f(String(e.result.length)))},e.onerror=e=>{r(new Error("failed to list existing analysis store in KanaDB: ".concat(e.target.errorCode)))}}))}else o=f(e);let d=await o;return await l,d[0]}(null,i,o,g),u=await l();postMessage({type:"KanaDB_store",resp:u,msg:"Success: Saved analysis to browser (".concat(c,")")})})).catch((e=>{console.error(e),A(t,e,w)}))}else if("REMOVEKDB"===t){var _=r.id;(async function(e){await a;let t=n.result.transaction(["analysis","analysis_meta","file","file_meta"],"readwrite"),r=new Promise(((r,n)=>{t.oncomplete=e=>{r(null)},t.onerror=t=>{n(new Error("transaction error when removing analysis ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}})),s=t.objectStore("analysis"),o=t.objectStore("analysis_meta"),i=t.objectStore("file"),l=t.objectStore("file_meta"),c=new Promise(((t,r)=>{let n=s.delete(e);n.onsuccess=e=>{t(!0)},n.onerror=t=>{r(new Error("failed to delete analysis ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}})),d=o.get(e),m=new Promise(((t,r)=>{d.onsuccess=r=>{let n=d.result,s=[];for(const e of Object.values(n.files.datasets))for(const t of e.files)s.push(f(t.id,i,l));let a=new Promise(((t,r)=>{let n=o.delete(e);n.onsuccess=e=>{t(!0)},n.onerror=t=>{r(new Error("failed to delete analysis metadata ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}}));s.push(a),t(s)},d.onerror=t=>{r(new Error("failed to retrieve analysis metadata ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}}));return await c,await u(m),await r,!0})(_).then((async e=>{let t=await l();postMessage({type:"KanaDB_store",resp:t,msg:"Success: Removed file from cache (".concat(_,")")})})).catch((e=>{console.error(e),A(t,e,w)}))}else if("PREFLIGHT_OPTIONS"===t)H.then((async e=>{let t={};try{let e=0,n={};for(const[t,s]of Object.entries(r.inputs.files)){if("uid"in s){let t=N[s.uid];if(Array.isArray(r.options)&&r.options.length>e){t.setOptions(r.options[e]);let s=await t.previewPrimaryIds({cache:!0});for(const e of["RNA","ADT","CRISPR"])e in s&&(n[e]?n[e].push(s[e]):n[e]=[s[e]])}}e++}for(const[s,o]of Object.entries(n))o.length!==r.options.length?t[s]=0:t[s]=m.y$(o).length}catch(n){console.error(n),t.status="ERROR",t.reason=n.toString()}postMessage({type:"PREFLIGHT_OPTIONS_DATA",resp:t,msg:"Success: PREFLIGHT_OPTIONS done"})}));else if("PREFLIGHT_INPUT"===t)H.then((async e=>{let t={};try{let e={},n={};for(const[t,s]of Object.entries(r.inputs.files))if("uid"in s)s.uid in N||(N[s.uid]=L(s),j[s.uid]=await N[s.uid].summary({cache:!0})),e[t]=N[s.uid],n[t]=K(j[s.uid],s);else{let r=L(s);e[t]=r,n[t]=K(await e[t].summary({cache:!0}),s)}t.status="SUCCESS",t.details=n}catch(n){console.error(n),t.status="ERROR",t.reason=n.toString()}postMessage({type:"PREFLIGHT_INPUT_DATA",resp:t,msg:"Success: PREFLIGHT_INPUT done"})})).catch((e=>{console.error(e),A(t,e,w)}));else if("computeVersusClusters"===t)H.then((e=>{let t,n,a=r.rank_type,i=r.modality,l=r.annotation;if(T===l)n=B.marker_detection.computeVersus(r.left,r.right),t=s.at(n.results[i],n.left,a);else{let e=o.GO(U(l));n=G(l,e).computeVersus(e.levels.indexOf(r.left),e.levels.indexOf(r.right)),t=s.at(n.results[i],n.left,a)}var c=[];v(t,c),postMessage({type:"computeVersusClusters",resp:t,msg:"Success: COMPUTE_VERSUS_CLUSTERS done"},c)})).catch((e=>{console.error(e),A(t,e,w)}));else if("computeVersusSelections"===t)H.then((e=>{let t=r.rank_type,n=B.custom_selections.computeVersus(r.left,r.right),o=s.at(n.results[r.modality],n.left,t);var a=[];v(o,a),postMessage({type:"computeVersusSelections",resp:o,msg:"Success: COMPUTE_VERSUS_SELECTIONS done"},a)})).catch((e=>{console.error(e),A(t,e,w)}));else if("getMarkersForCluster"===t)H.then((e=>{let t,n,a=r.cluster,i=r.rank_type,l=r.modality,c=r.annotation;if(T===c)n=B.marker_detection.fetchResults()[l],t=s.at(n,a,i);else{let e=o.GO(U(c));n=G(c,e).fetchResults()[l],t=s.at(n,e.levels.indexOf(a),i)}var u=[];v(t,u),postMessage({type:"setMarkersForCluster",resp:t,msg:"Success: GET_MARKERS_FOR_CLUSTER done"},u)})).catch((e=>{console.error(e),A(t,e,w)}));else if("getGeneExpression"===t)H.then((e=>{let t=r.gene,n=r.modality;const s=V(n);let o;if("RNA"===n)o=s.get(n).row(t);else if("ADT"===n)o=s.get(n).row(t);else{if("CRISPR"!==n)throw new Error("unknown feature type '"+n+"'");o=s.get(n).row(t)}postMessage({type:"setGeneExpression",resp:{gene:t,expr:o},msg:"Success: GET_GENE_EXPRESSION done"},[o.buffer])})).catch((e=>{console.error(e),A(t,e,w)}));else if("computeCustomMarkers"===t)H.then((e=>{B.custom_selections.addSelection(r.id,r.selection),postMessage({type:"computeCustomMarkers",msg:"Success: COMPUTE_CUSTOM_MARKERS done"})})).catch((e=>{console.error(e),A(t,e,w)}));else if("getMarkersForSelection"===t)H.then((e=>{let t=B.custom_selections.fetchResults(r.cluster)[r.modality],n=s.at(t,1,r.rank_type);var o=[];v(n,o),postMessage({type:"setMarkersForCustomSelection",resp:n,msg:"Success: GET_MARKERS_FOR_SELECTION done"},o)})).catch((e=>{console.error(e),A(t,e,w)}));else if("removeCustomMarkers"===t)H.then((e=>{B.custom_selections.removeSelection(r.id)})).catch((e=>{console.error(e),A(t,e,w)}));else if("animateTSNE"===t)H.then((async e=>{await B.tsne.animate(),E("tsne",await B.tsne.fetchResults())})).catch((e=>{console.error(e),A(t,e,w)}));else if("animateUMAP"===t)H.then((async e=>{await B.umap.animate(),E("umap",await B.umap.fetchResults())})).catch((e=>{console.error(e),A(t,e,w)}));else if("getAnnotation"===t)H.then((e=>{let t,n,s=r.annotation;if(t=U(s,!!r.unfiltered),ArrayBuffer.isView(t))n={type:"array",values:t.slice()};else{let e=[],r={},s=new Int32Array(t.length);t.map(((t,n)=>{t in r||(r[t]=e.length,e.push(t)),s[n]=r[t]})),n={type:"factor",index:s,levels:e}}let o=[];v(n,o),postMessage({type:"setAnnotation",resp:{annotation:s,values:n},msg:"Success: GET_ANNOTATION done"},o)})).catch((e=>{console.error(e),A(t,e,w)}));else if("computeFeaturesetSummary"===t)H.then((async e=>{let t,{annotation:n,rank_type:s,cluster:a}=r,i=s.indexOf("-");if(T===n)t=B.feature_set_enrichment.computeEnrichment(B.marker_detection.fetchResults().RNA,a,s.slice(0,i),s.slice(i+1)),E("computeFeaturesetSummary",t);else if(x===n){let e=B.custom_selections.fetchSelectionIndices(a),r=B.cell_filtering.fetchFilteredMatrix().numberOfColumns(),l=new Uint8Array(r);e.map((e=>l.set([1],e)));let c=o.GO(l),u=G(n,c).fetchResults().RNA;t=B.feature_set_enrichment.computeEnrichment(u,c.levels.indexOf(1),s.slice(0,i),s.slice(i+1)),E("computeFeaturesetSummary",t)}else{let e=o.GO(U(n)),r=G(n,e).fetchResults().RNA;t=B.feature_set_enrichment.computeEnrichment(r,e.levels.indexOf(a),s.slice(0,i),s.slice(i+1)),E("computeFeaturesetSummary",t)}})).catch((e=>{console.error(e),A(t,e,w)}));else if("computeFeaturesetVSSummary"===t)H.then((async e=>{let t,{annotation:n,rank_type:s,left:a,right:i}=r,l=s.indexOf("-");if(T===n){let e=B.marker_detection.computeVersus(a,i);t=B.feature_set_enrichment.computeEnrichment(e.results.RNA,e.left,s.slice(0,l),s.slice(l+1)),E("computeFeaturesetVSSummary",t)}else if(x===n){let e=B.custom_selections.computeVersus(a,i);t=B.feature_set_enrichment.computeEnrichment(e.results.RNA,0,s.slice(0,l),s.slice(l+1)),E("computeFeaturesetVSSummary",t)}else{let e=o.GO(U(n)),a=G(n,e).computeVersus(e.levels.indexOf(r.left),e.levels.indexOf(r.right));t=B.feature_set_enrichment.computeEnrichment(a.results.RNA,a.left,s.slice(0,l),s.slice(l+1)),E("computeFeaturesetVSSummary",t)}})).catch((e=>{console.error(e),A(t,e,w)}));else if("getFeatureScores"===t)H.then((e=>{let{index:t}=r;E("setFeatureScores",B.feature_set_enrichment.computePerCellScores(t))})).catch((e=>{console.error(e),A(t,e,w)}));else if("getFeatureGeneIndices"===t)H.then((e=>{let t,n,{index:a,cluster:i,annotation:l,modality:c,rank_type:u}=r,f=B.feature_set_enrichment.fetchFeatureSetIndices(a);if(T===l)t=B.marker_detection.fetchResults()[c],n=s.at(t,i,u);else if(x===l)t=B.custom_selections.fetchResults(r.cluster)[r.modality],n=s.at(t,1,r.rank_type);else{let e=o.GO(U(l));t=G(l,e).fetchResults()[c],n=s.at(t,e.levels.indexOf(i),u)}let d=n.ordering.map(((e,t)=>f.includes(e)?t:-100)).filter((e=>-100!==e)),m={};for(const[r,s]of Object.entries(n))m[r]=s.map(((e,t)=>d.includes(t)?e:-100)).filter((e=>-100!==e));E("setFeatureGeneIndices",m)})).catch((e=>{console.error(e),A(t,e,w)}));else if("computeCellAnnotation"===t){let{annotation:e,cluster:t}=r,n={per_reference:{}},s=null;if(T===e)s=B.marker_detection.fetchResults();else if(x===e)s=B.custom_selections.fetchResults(t);else{s=G(e,o.GO(U(e))).fetchResults()}null!==s&&"RNA"in s&&(n=B.cell_labelling.computeLabels(s.RNA)),E("computeCellAnnotation",n)}else console.error("Type: ".concat(t," not defined")),A(t,"Type: ".concat(t," not defined"),w)}}},t={};function r(n){var s=t[n];if(void 0!==s)return s.exports;var o=t[n]={id:n,loaded:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.loaded=!0,o.exports}r.m=e,r.x=()=>{var e=r.O(void 0,[764,705,522],(()=>r(2866)));return e=r.O(e)},(()=>{var e=[];r.O=(t,n,s,o)=>{if(!n){var a=1/0;for(u=0;u<e.length;u++){n=e[u][0],s=e[u][1],o=e[u][2];for(var i=!0,l=0;l<n.length;l++)(!1&o||a>=o)&&Object.keys(r.O).every((e=>r.O[e](n[l])))?n.splice(l--,1):(i=!1,o<a&&(a=o));if(i){e.splice(u--,1);var c=s();void 0!==c&&(t=c)}}return t}o=o||0;for(var u=e.length;u>0&&e[u-1][2]>o;u--)e[u]=e[u-1];e[u]=[n,s,o]}})(),r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce(((t,n)=>(r.f[n](e,t),t)),[])),r.u=e=>"static/js/"+e+"."+{343:"41526f1f",433:"1a280f0e",522:"1ea0527e",705:"4ba25ce9",764:"c63fbfc6",814:"75f32851"}[e]+".chunk.js",r.miniCssF=e=>{},r.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),r.p="/kana/",(()=>{r.b=self.location+"/../../../";var e={866:1};r.f.i=(t,n)=>{e[t]||importScripts(r.p+r.u(t))};var t=self.webpackChunkkana=self.webpackChunkkana||[],n=t.push.bind(t);t.push=t=>{var s=t[0],o=t[1],a=t[2];for(var i in o)r.o(o,i)&&(r.m[i]=o[i]);for(a&&a(r);s.length;)e[s.pop()]=1;n(t)}})(),(()=>{var e=r.x;r.x=()=>Promise.all([764,705,522].map(r.e,r)).then(e)})();r.x()})();
//# sourceMappingURL=866.c4b1be04.chunk.js.map