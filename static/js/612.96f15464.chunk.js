(()=>{"use strict";var e={9612:(e,t,r)=>{var s,n=r(797),o=r(5831),a=null;function i(){var e=s.result.transaction(["analysis_meta"],"readonly").objectStore("analysis_meta").getAll();return new Promise(((t,r)=>{e.onsuccess=r=>{let s=e.result;s.forEach((e=>{delete e.files})),t(s)},e.onerror=e=>{r(new Error("failed to query the analysis store in KanaDB: ".concat(e.target.errorCode)))}}))}async function c(){return await a,i()}async function l(e){await a;let t=s.result.transaction(["file"],"readonly").objectStore("file"),r=new Promise(((r,s)=>{let n=t.get(e);n.onsuccess=e=>{r(void 0!==n.result?n.result:null)},n.onerror=t=>{s(new Error("failed to retrieve file ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}}));var n=await r;return null!==n&&(n=new Uint8Array(n.payload)),n}async function u(e){let t=await e;if(t instanceof Array){let e=[];for(const r of t)e.push(await u(r));t=e}return t}function f(e,t,r){let s=r.get(e);return new Promise(((n,o)=>{s.onsuccess=o=>{let a=s.result;var i=a.count-1,c=[];0===i?(c.push(new Promise(((r,s)=>{let n=t.delete(e);n.onsuccess=e=>{r(!0)},n.onerror=t=>{s(new Error("failed to remove file ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}}))),c.push(new Promise(((t,s)=>{let n=r.delete(e);n.onsuccess=e=>{t(!0)},n.onerror=t=>{s(new Error("failed to remove file metadata ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}})))):c.push(new Promise(((t,s)=>{a.count=i;let n=r.put(a);n.onsuccess=e=>{t(!0)},n.onerror=t=>{s(new Error("failed to update file metadata ".concat(e," in KanaDB: ").concat(t.target.errorCode)))}}))),n(c)},s.onerror=t=>{console.log(t),o(new Error("failed to retrieve file metadata ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}}))}var d,m=r(7325),p=r(8109),h=r(6418),y=null;async function w(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(await y,!r){let t=d.result.transaction(["downloads"],"readonly").objectStore("downloads");var s=new Promise(((r,s)=>{var n=t.get(e);n.onsuccess=e=>{void 0!==n.result?r(n.result.payload):r(null)},n.onerror=t=>{s("failed to query DownloadsDB for ".concat(e,": ").concat(t.target.errorCode))}})),n=await s;if(null!==n)return n}var o;o=null==t?fetch(e):fetch(e,t);var a=await o;if(!a.ok)throw new Error("failed to download '"+e+"' ("+a.status+")");var i=await a.arrayBuffer();let c=d.result.transaction(["downloads"],"readwrite"),l=new Promise(((t,r)=>{c.oncomplete=e=>{t(null)},c.onerror=t=>{r(new Error("transaction error for saving ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}})),u=c.objectStore("downloads"),f=new Promise(((t,r)=>{var s=u.put({url:e,payload:i});s.onsuccess=e=>{t(!0)},s.onerror=t=>{r(new Error("failed to cache ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}}));return await f,await l,i}var _=r(5587),g=r.n(_);const b="https://cors-proxy.aaron-lun.workers.dev";async function S(e){let t=await w(b+"/"+encodeURIComponent(e));return new Uint8Array(t)}function v(e,t){if(e)if(Array.isArray(e))for(const r of e)v(r,t);else if(e.constructor==Object)for(const[r,s]of Object.entries(e))v(s,t);else if(ArrayBuffer.isView(e)){if(!(e.buffer instanceof ArrayBuffer))throw"only ArrayBuffers should be in the message payload";t.push(e.buffer)}}function O(e){postMessage({type:"".concat(e,"_START")})}function E(e,t){if("undefined"==typeof t)postMessage({type:"".concat(e,"_CACHE")});else{var r=[];v(t,r),postMessage({type:"".concat(e,"_DATA"),resp:t},r)}}function R(e,t,r){postMessage({type:"".concat(e,"_ERROR"),resp:{reason:t.toString(),fatal:r}})}function C(e,t,r){for(var s={},n=r.slice(),o=0;o<t.length;o++){let r={};for(const[t,s]of Object.entries(e))r[t]=s.slice().filter(((e,t)=>n[t]==o));s[t[o]]=r}return s}function A(e,t){var r={};for(const n of t)r[n]={};for(const[n,o]of Object.entries(e))for(var s=0;s<t.length;s++)r[t[s]][n]=o[s];return r}function D(e){return Array.isArray(e)||ArrayBuffer.isView(e)}function P(e){let t,{all:r=!1,unique:s=!1,colname:o=null}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(D(e)){t=n.Qr(e);const a=new Set(e);t.num_unique=a.size,a.size<=50&s&&(t.values=[...a].sort()),r&&(t._all_=e),"continuous"===t.type&&a.size<=50&&(t.type="both"),("string"===typeof o||o instanceof String)&&(t.name=o)}return t}n.ES.setDownload(S),m.b5(S),n.E4.setDownload(S),m.ao((async(e,t,r)=>{let s=m.XZ()+"/"+e,n=b+"/"+encodeURIComponent(s);if(null==t&&null==r){let e=await w(n);return new Response(e)}return fetch(n+"?start="+String(t)+"&end="+String(r))})),m.d9((async e=>{let t=m.Kk()+"/"+e,r=await w(b+"/"+encodeURIComponent(t));return new Response(r)})),h.M.setDownloadFun(S),n.cO.ExperimentHub=h.M;r(3841);const j="K@\ud835\udf02a#$c3ll";"".concat(j,"::CLUSTERS"),"".concat(j,"::SELECTION");const M="".concat(j,"::CLUSTERS"),k="".concat(j,"::SELECTION");let x=null,B={},T={},N=null,F={};function I(e){if("10X"===e.format)return new n.By(e.h5,e.options?e.options:{});if("MatrixMarket"===e.format)return new n.en(e.mtx,e.genes||null,e.annotations||null,e.options?e.options:{});if("H5AD"===e.format)return new n.Fl(e.h5,e.options?e.options:{});if("SummarizedExperiment"===e.format)return new n.H$(e.rds,e.options?e.options:{});if("ZippedADB"===e.format)return new n.cj(e.zipname,e.zipfile,e.options?e.options:{});if("ExperimentHub"===e.format)return new h.M(e.id,e.options?e.options:{});throw new Error("unknown format '"+e.format+"'")}function K(e,t){let r={};for(const n of e.cells.columnNames()){const t=e.cells.column(n);D(t)&&(r[n]=P(t,{all:!0,unique:!0,colname:n}))}let s={cells:{columns:r,numberOfCells:e.cells.numberOfRows()}};if("H5AD"===t.format){s.all_features={};let t={};for(const r of e.all_features.columnNames()){const s=e.all_features.column(r);D(s)&&(t[r]=P(s,{all:!0,unique:!0,colname:r}))}s.all_features={columns:t,numberOfFeatures:e.all_features.numberOfRows(),rownames:Array.isArray(e.all_features.rowNames())}}else if("SummarizedExperiment"===t.format){if(s.modality_features={},"modality_features"in e)for(const[n,o]of Object.entries(e.modality_features)){let e={};for(const t of o.columnNames()){const r=o.column(t);D(r)&&(e[t]=P(r,{all:!0,unique:!0,colname:t}))}s.modality_features[n]={columns:e,numberOfFeatures:o.numberOfRows(),rownames:Array.isArray(o.rowNames())}}}else if(s.modality_features={},"modality_features"in e)for(const[n,o]of Object.entries(e.modality_features)){let e={};for(const t of o.columnNames()){const r=o.column(t);D(r)&&(e[t]=P(r,{all:!0,unique:!0,colname:t}))}s.modality_features[n]={columns:e,numberOfFeatures:o.numberOfRows(),rownames:Array.isArray(o.rowNames())}}return"H5AD"===t.format?s.all_assay_names=e.all_assay_names:"SummarizedExperiment"!==t.format&&"ZippedADB"!==t.format||(s.modality_assay_names=e.modality_assay_names),s}async function L(e){try{let t=await async function(e,t){if(e[t].changed){if("inputs"===t){let r={},n={};for(const s of e[t].fetchCountMatrix().available())n[s]=e[t].fetchCountMatrix().get(s).numberOfRows();let o={};for(const[s,i]of Object.entries(e[t].fetchFeatureAnnotations())){let e={};for(const t of i.columnNames()){let r=i.column(t);Array.isArray(r)&&(e[t]=r)}Array.isArray(i.rowNames())&&(e.rownames=i.rowNames()),o[s]=e}let a={};for(const s of e[t].fetchCellAnnotations().columnNames()){let r=e[t].fetchCellAnnotations().column(s);if(D(r)){const e=P(r,{all:!1,unique:!0,colname:s});a[s]=e}}if(null!==(s=e[t].fetchBlockLevels())){const r=e[t].fetchBlock().slice();if(D(r)){const e=P(r,{all:!1,unique:!0,colname:"__batch__"});a.__batch__=e}}return r={num_cells:e[t].fetchCountMatrix().numberOfColumns(),num_genes:n,genes:o,annotations:a},r}if("rna_quality_control"===t){let r={sums:e[t].fetchMetrics().sums(),detected:e[t].fetchMetrics().detected(),proportion:e[t].fetchMetrics().subsetProportions(0)},n={};if(null===(s=e.inputs.fetchBlockLevels()))s=["default"],n.data={default:r};else{let t=e.inputs.fetchBlock();n.data=C(r,s,t)}let o={sums:e[t].fetchFilters().thresholdsSums(),detected:e[t].fetchFilters().thresholdsDetected(),proportion:e[t].fetchFilters().thresholdsSubsetProportions(0)};return n.thresholds=A(o,s),n}if("adt_quality_control"===t){let n={sums:e[t].fetchMetrics().sums(),detected:e[t].fetchMetrics().detected(),proportion:e[t].fetchMetrics().subsetTotals(0)};var r={};if(null===(s=e.inputs.fetchBlockLevels()))s=["default"],r.data={default:n};else{let t=e.inputs.fetchBlock();r.data=C(n,s,t)}let o={detected:e[t].fetchFilters().thresholdsDetected(),proportion:e[t].fetchFilters().thresholdsSubsetTotals(0)};r.thresholds=A(o,s);for(const[e,t]of Object.entries(r.thresholds))t.sums=NaN;return r}if("crispr_quality_control"===t){let r={sums:e[t].fetchMetrics().sums(),detected:e[t].fetchMetrics().detected(),proportion:e[t].fetchMetrics().maxProportions()},n={};var s;if(null===(s=e.inputs.fetchBlockLevels()))s=["default"],n.data={default:r};else{let t=e.inputs.fetchBlock();n.data=C(r,s,t)}let o={count:e[t].fetchFilters().thresholdsMaxCount(0)};return n.thresholds=A(o,s),n}if("cell_filtering"===t){let r=0,s=null;const n=e[t].fetchDiscards();return n?(n.forEach((e=>{r+=0==e})),s=n.slice()):r=e.inputs.fetchCountMatrix().numberOfColumns(),{retained:r,discard:s}}if("rna_normalization"===t)return{};if("adt_normalization"===t)return{};if("crispr_normalization"===t)return{};if("feature_selection"===t)return{means:e[t].fetchResults().means(),vars:e[t].fetchResults().variances(),fitted:e[t].fetchResults().fitted(),resids:e[t].fetchResults().residuals()};if("rna_pca"===t||"adt_pca"===t||"crispr_pca"===t){let r=e[t].fetchPCs();var n=r.varianceExplained(),o=r.totalVariance();return n.forEach(((e,t)=>{n[t]=e/o})),{var_exp:n}}if("combine_embeddings"===t)return{};if("batch_correction"===t)return{};if("neighbor_index"===t)return{};if("tsne"===t||"umap"===t)return await e[t].fetchResults();if("kmeans_cluster"===t)return{};if("snn_graph_cluster"===t)return{};if("choose_clustering"===t)return{clusters:e[t].fetchClusters().slice()};if("marker_detection"===t)return{};if("cell_labelling"===t){let r=e.marker_detection.fetchResults();return"RNA"in r?e[t].computeLabels(r.RNA):{per_reference:{}}}if("custom_selections"===t)return{};if("feature_set_enrichment"===t){let t=e.feature_set_enrichment.fetchCollectionDetails(),r=e.feature_set_enrichment.fetchSetDetails();return{collections:t,sets:{names:r.names,descriptions:r.descriptions,sizes:r.sizes.slice(),collections:r.collections.slice()}}}}}(x,e);E(e,t)}catch(t){console.error(t),R(e,t,!0)}}function z(e,t){let r;return e in F||(r=new n.J6(V(),t.ids.slice()),r.computeAll(),F[e]=r),F[e]}n.$p(((e,t,r,s)=>{postMessage({type:e+"_iter",x:t,y:r,iteration:s},[t.buffer,r.buffer])})),n.ED(l);const U=function(e){let t,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if("__batch__"===e)t=x.inputs.fetchBlock().slice();else if(e.startsWith("".concat(j,"::QC::"))){let r=e.replace("".concat(j,"::QC::"),"").split("_"),s=x["".concat(r[0].toLowerCase(),"_quality_control")].fetchMetrics();"sums"===r[1]?t=s.sums():"detected"===r[1]?t=s.detected():"proportion"===r[1]&&("rna"===r[0].toLowerCase()?t=s.subsetProportions(0):"adt"===r[0].toLowerCase()?t=s.subsetTotals(0):"crispr"===r[0].toLowerCase()&&(t=s.maxProportions(0)))}else t=x.inputs.fetchCellAnnotations().column(e);return r||(t=x.cell_filtering.applyFilter(t)),t.slice()},V=()=>{if(null===N){N=new o.VU;let e={RNA:"rna_normalization",ADT:"adt_normalization",CRISPR:"crispr_normalization"};for(const[t,r]of Object.entries(e)){let e=x[r];e.valid()&&N.add(t,e.fetchNormalizedMatrix())}}return N};var H;onmessage=function(e){const{type:t,payload:r}=e.data;let w=!1;if("INIT"===t){w=!0;let e=Math.round(2*navigator.hardwareConcurrency/3),r=n.j2({numberOfThreads:e}),o=r.then((()=>n.TN()));o.then((e=>{x=e,postMessage({type:t,msg:"Success: analysis state created"})}));let c=a=new Promise((e=>{(s=indexedDB.open("KanaDB",2)).onupgradeneeded=e=>{var t=e.target.result;try{t.deleteObjectStore("analysis")}catch(e){}try{t.deleteObjectStore("analysis_meta")}catch(e){}try{t.deleteObjectStore("file")}catch(e){}try{t.deleteObjectStore("file_meta")}catch(e){}t.createObjectStore("analysis",{keyPath:"id"}),t.createObjectStore("analysis_meta",{keyPath:"id"}),t.createObjectStore("file",{keyPath:"id"}),t.createObjectStore("file_meta",{keyPath:"id"})},s.onsuccess=()=>{e(i())},s.onerror=()=>{e(null)}}));c.then((e=>{null!==e&&postMessage({type:"KanaDB_store",resp:e,msg:"Success: KanaDB initialized"})})).catch((e=>{console.error(e),postMessage({type:"KanaDB_ERROR",msg:"Error: Cannot initialize KanaDB"})}));let l=(null===y&&(y=new Promise(((e,t)=>{(d=indexedDB.open("DownloadsDB",3)).onupgradeneeded=e=>{var t=e.target.result;try{t.deleteObjectStore("downloads")}catch(e){}t.createObjectStore("downloads",{keyPath:"url"})},d.onsuccess=()=>{e(null)},d.onerror=()=>{t("failed to initialize DownloadsDB")}}))),y);l.then((e=>{postMessage({type:"DownloadsDB_store",resp:e,msg:"Success: DownloadsDB initialized"})})).catch((e=>{console.error(e),postMessage({type:"DownloadsDB_ERROR",msg:"Error: Cannot initialize DownloadsDB"})}));try{let e=h.M.availableDatasets();postMessage({type:"ExperimentHub_store",resp:e,msg:"Success: ExperimentHub initialized"})}catch(S){console.error(S),postMessage({type:"ExperimentHub_ERROR",msg:"Error: Cannot access datasets in ExperimentHub"})}(H=Promise.all([r,c,l,o])).then((()=>{postMessage({type:t,msg:"Success: bakana initialized"})})).catch((e=>{console.error(e),R(t,e,w)}))}else if("RUN"===t)w=!0,H.then((e=>{let s=r.inputs,o=s.files;if(null!==o){let e={};for(const[t,r]of Object.entries(o))"uid"in r&&r.uid in B?e[t]=B[r.uid]:e[t]=I(r),e[t].setOptions(r.options);for(const[t,r]of Object.entries(B))r.clear(),delete B[t];o=e}(()=>{for(const[e,t]of Object.entries(F))t.free();F={}})();let a=function(e,t){let r=t,s=(e,t,s)=>{if("undefined"==typeof s)throw new Error("cannot assign undefined parameter to '"+e+"."+t+"'");if(!(e in r))throw new Error("unknown analysis step '"+e+"'");let n=r[e];if(!(t in n))throw new Error("unknown analysis parameter '"+t+"' for step '"+e+"'");n[t]=s};s("inputs","block_factor",e.batch),s("inputs","subset",e.subset),n.TD(r,t.batch_correction.method),n.bN(r,t.neighbor_index.approximate),null!==r.combine_embeddings.weights&&new Set([r.combine_embeddings.rna_weight,r.combine_embeddings.adt_weight,r.combine_embeddings.crispr_weight]).size<=1&&(r.combine_embeddings.weights=null);return r}(s,r.params);n.x6(x,o,a,{startFun:O,finishFun:L}).catch((e=>{console.error(e),R(t,e,w)}))})).catch((e=>{console.error(e),R(t,e,w)}));else if("LOAD"===t){w=!0;let e=r.inputs.files;if("kana"===e[Object.keys(e)[0]].format){let r=e[Object.keys(e)[0]].file;H.then((async e=>{const t=(new FileReaderSync).readAsArrayBuffer(r),s=await g().loadAsync(t);let o=JSON.parse(await s.file("config.json").async("string")),a={};for(const r in s.files)if(r.startsWith("datasets/")){let e=await s.files[r].async("uint8array");a[r.split("/")[1]]=e}x=await n.j5(o,(e=>a[e]),{state:x,startFun:O,finishFun:L});const i={custom_selections:x.custom_selections.fetchSelections()};var c=[];v(o.parameters,c),postMessage({type:"loadedParameters",resp:{parameters:o.parameters,other:i}},c);let l={},u={};const f=x.inputs.fetchDatasets();for(const[r,n]of Object.entries(f)){let e=await n.previewPrimaryIds({cache:!0});for(const t of["RNA","ADT","CRISPR"])t in e&&(l[t]?l[t].push(e[t]):l[t]=[e[t]])}for(const[r,n]of Object.entries(l))u[r]=m.wf(n).length;postMessage({type:"PREFLIGHT_OPTIONS_DATA",resp:u,msg:"Success: PREFLIGHT_OPTIONS done"})})).catch((e=>{console.error(e),R(t,e,w)}))}else"kanadb"===e[Object.keys(e)[0]].format&&H.then((async t=>{var r=e[Object.keys(e)[0]].file;const o=await async function(e){await a;let t=s.result.transaction(["analysis"],"readonly").objectStore("analysis"),r=new Promise(((r,s)=>{let n=t.get(e);n.onsuccess=e=>{r(void 0!==n.result?n.result:null)},n.onerror=t=>{s(new Error("failed to retrieve analysis ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}}));var n=await r;return null!==n&&(n=new Uint8Array(n.payload)),n}(r),i=new TextDecoder;let c=JSON.parse(i.decode(o));x=await n.j5(c,l,{state:x,startFun:O,finishFun:L})})).catch((e=>{console.error(e),R(t,e,w)}))}else if("EXPORT"===t)H.then((async e=>{let t=[],r=await n.JZ(x,((e,r,s)=>{let n=String(t.length);return t.push(s.buffer()),n}));const s=new(g());s.file("config.json",JSON.stringify(r));for(var o=0;o<t.length;o++)s.file("datasets/"+String(o),t[o]);let a=await s.generateAsync({type:"uint8array"});postMessage({type:"exportState",resp:a,msg:"Success: application state exported"},[a.buffer])})).catch((e=>{console.error(e),R(t,e,w)}));else if("EXPORT_RDS"===t)H.then((async e=>{let t=await n.lC(x,"sce",{forceBuffer:!0}),r=await n.bL(x,"",{forceBuffer:!0});for(const n of r)t.push(n);let s=await n.o2(t);postMessage({type:"exportRDSState",resp:s,msg:"Success: application state exported"},[s.buffer])})).catch((e=>{console.error(e),R(t,e,w)}));else if("SAVEKDB"===t){var _=r.title;H.then((async e=>{let r=[],o=await n.JZ(x,(async(e,n,o)=>{let i=o.buffer();var c=await p.FB(i),l=t+"_"+o.name()+"_"+i.length+"_"+c;return await async function(e,t){await a;let r=s.result.transaction(["file","file_meta"],"readwrite"),n=new Promise(((t,s)=>{r.oncomplete=e=>{t(null)},r.onerror=t=>{s(new Error("transaction error when saving file ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}})),o=r.objectStore("file"),i=r.objectStore("file_meta"),c=i.get(e),l=new Promise(((r,s)=>{c.onsuccess=s=>{let n=c.result;"undefined"===typeof n?n={count:1,id:e}:n.count++;var a=new Promise(((r,s)=>{var n=o.put({id:e,payload:t.buffer});n.onsuccess=e=>{r(!0)},n.onerror=t=>{s(new Error("failed to save file ".concat(e," in KanaDB: ").concat(t.target.errorCode)))}})),l=new Promise(((t,r)=>{var s=i.put(n);s.onsuccess=e=>{t(!0)},s.onerror=t=>{r(new Error("failed to save metadata for file ".concat(e," in KanaDB: ").concat(t.target.errorCode)))}}));r(Promise.all([a,l]))},c.onerror=t=>{s(new Error("failed to retrieve metadata ".concat(e," in KanaDB: ").concat(t.target.errorCode)))}}));await n,await l}(l,i),r.push(l),l}));let i=(new TextEncoder).encode(JSON.stringify(o)),l=await async function(e,t,r,n){await a;let o,i=s.result.transaction(["analysis","analysis_meta"],"readwrite"),c=new Promise(((t,r)=>{i.oncomplete=e=>{t(null)},i.onerror=t=>{r(new Error("transaction error when saving analysis ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}})),l=i.objectStore("analysis"),u=i.objectStore("analysis_meta"),f=e=>{var s=new Promise(((r,s)=>{var n=l.put({id:e,payload:t.buffer});n.onsuccess=e=>{r(!0)},n.onerror=t=>{s(new Error("failed to save analysis file ".concat(e," in KanaDB: ").concat(t.target.errorCode)))}})),o=new Promise(((t,s)=>{var o=u.put({id:e,files:r,time:Number(new Date),title:n});o.onsuccess=e=>{t(!0)},o.onerror=t=>{s(new Error("failed to save analysis metadata ".concat(e," in KanaDB: ").concat(t.target.errorCode)))}}));return[e,s,o]};if(null===e){let e=u.getAll();o=new Promise(((t,r)=>{e.onsuccess=r=>{t(f(String(e.result.length)))},e.onerror=e=>{r(new Error("failed to list existing analysis store in KanaDB: ".concat(e.target.errorCode)))}}))}else o=f(e);let d=await o;return await c,d[0]}(null,i,o,_),u=await c();postMessage({type:"KanaDB_store",resp:u,msg:"Success: Saved analysis to browser (".concat(l,")")})})).catch((e=>{console.error(e),R(t,e,w)}))}else if("REMOVEKDB"===t){var b=r.id;(async function(e){await a;let t=s.result.transaction(["analysis","analysis_meta","file","file_meta"],"readwrite"),r=new Promise(((r,s)=>{t.oncomplete=e=>{r(null)},t.onerror=t=>{s(new Error("transaction error when removing analysis ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}})),n=t.objectStore("analysis"),o=t.objectStore("analysis_meta"),i=t.objectStore("file"),c=t.objectStore("file_meta"),l=new Promise(((t,r)=>{let s=n.delete(e);s.onsuccess=e=>{t(!0)},s.onerror=t=>{r(new Error("failed to delete analysis ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}})),d=o.get(e),m=new Promise(((t,r)=>{d.onsuccess=r=>{let s=d.result,n=[];for(const e of Object.values(s.files.datasets))for(const t of e.files)n.push(f(t.id,i,c));let a=new Promise(((t,r)=>{let s=o.delete(e);s.onsuccess=e=>{t(!0)},s.onerror=t=>{r(new Error("failed to delete analysis metadata ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}}));n.push(a),t(n)},d.onerror=t=>{r(new Error("failed to retrieve analysis metadata ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}}));return await l,await u(m),await r,!0})(b).then((async e=>{let t=await c();postMessage({type:"KanaDB_store",resp:t,msg:"Success: Removed file from cache (".concat(b,")")})})).catch((e=>{console.error(e),R(t,e,w)}))}else if("PREFLIGHT_OPTIONS"===t)H.then((async e=>{let t={};try{let e=0,s={};for(const[t,n]of Object.entries(r.inputs.files)){if("uid"in n){let t=B[n.uid];if(Array.isArray(r.options)&&r.options.length>e){t.setOptions(r.options[e]);let n=await t.previewPrimaryIds({cache:!0});for(const e of["RNA","ADT","CRISPR"])e in n&&(s[e]?s[e].push(n[e]):s[e]=[n[e]])}}e++}for(const[n,o]of Object.entries(s))o.length!==r.options.length?t[n]=0:t[n]=m.wf(o).length}catch(s){console.error(s),t.status="ERROR",t.reason=s.toString()}postMessage({type:"PREFLIGHT_OPTIONS_DATA",resp:t,msg:"Success: PREFLIGHT_OPTIONS done"})}));else if("PREFLIGHT_INPUT"===t)H.then((async e=>{let t={};try{let e={},s={};for(const[t,n]of Object.entries(r.inputs.files))if("uid"in n)n.uid in B||(B[n.uid]=I(n),T[n.uid]=await B[n.uid].summary({cache:!0})),e[t]=B[n.uid],s[t]=K(T[n.uid],n);else{let r=I(n);e[t]=r,s[t]=K(await e[t].summary({cache:!0}),n)}t.status="SUCCESS",t.details=s}catch(s){console.error(s),t.status="ERROR",t.reason=s.toString()}postMessage({type:"PREFLIGHT_INPUT_DATA",resp:t,msg:"Success: PREFLIGHT_INPUT done"})})).catch((e=>{console.error(e),R(t,e,w)}));else if("computeVersusClusters"===t)H.then((e=>{let t,s,a=r.rank_type,i=r.modality,c=r.annotation;if(M===c)s=x.marker_detection.computeVersus(r.left,r.right),t=n.jJ(s.results[i],s.left,a);else{let e=o.Yh(U(c));s=z(c,e).computeVersus(e.levels.indexOf(r.left),e.levels.indexOf(r.right)),t=n.jJ(s.results[i],s.left,a)}var l=[];v(t,l),postMessage({type:"computeVersusClusters",resp:t,msg:"Success: COMPUTE_VERSUS_CLUSTERS done"},l)})).catch((e=>{console.error(e),R(t,e,w)}));else if("computeVersusSelections"===t)H.then((e=>{let t=r.rank_type,s=x.custom_selections.computeVersus(r.left,r.right),o=n.jJ(s.results[r.modality],s.left,t);var a=[];v(o,a),postMessage({type:"computeVersusSelections",resp:o,msg:"Success: COMPUTE_VERSUS_SELECTIONS done"},a)})).catch((e=>{console.error(e),R(t,e,w)}));else if("getMarkersForCluster"===t)H.then((e=>{let t,s,a=r.cluster,i=r.rank_type,c=r.modality,l=r.annotation;if(M===l)s=x.marker_detection.fetchResults()[c],t=n.jJ(s,a,i);else{let e=o.Yh(U(l));s=z(l,e).fetchResults()[c],t=n.jJ(s,e.levels.indexOf(a),i)}var u=[];v(t,u),postMessage({type:"setMarkersForCluster",resp:t,msg:"Success: GET_MARKERS_FOR_CLUSTER done"},u)})).catch((e=>{console.error(e),R(t,e,w)}));else if("getGeneExpression"===t)H.then((e=>{let t=r.gene,s=r.modality;const n=V(s);let o;if("RNA"===s)o=n.get(s).row(t);else if("ADT"===s)o=n.get(s).row(t);else{if("CRISPR"!==s)throw new Error("unknown feature type '"+s+"'");o=n.get(s).row(t)}postMessage({type:"setGeneExpression",resp:{gene:t,expr:o},msg:"Success: GET_GENE_EXPRESSION done"},[o.buffer])})).catch((e=>{console.error(e),R(t,e,w)}));else if("computeCustomMarkers"===t)H.then((e=>{x.custom_selections.addSelection(r.id,r.selection),postMessage({type:"computeCustomMarkers",msg:"Success: COMPUTE_CUSTOM_MARKERS done"})})).catch((e=>{console.error(e),R(t,e,w)}));else if("getMarkersForSelection"===t)H.then((e=>{let t=x.custom_selections.fetchResults(r.cluster)[r.modality],s=n.jJ(t,1,r.rank_type);var o=[];v(s,o),postMessage({type:"setMarkersForCustomSelection",resp:s,msg:"Success: GET_MARKERS_FOR_SELECTION done"},o)})).catch((e=>{console.error(e),R(t,e,w)}));else if("removeCustomMarkers"===t)H.then((e=>{x.custom_selections.removeSelection(r.id)})).catch((e=>{console.error(e),R(t,e,w)}));else if("animateTSNE"===t)H.then((async e=>{await x.tsne.animate(),E("tsne",await x.tsne.fetchResults())})).catch((e=>{console.error(e),R(t,e,w)}));else if("animateUMAP"===t)H.then((async e=>{await x.umap.animate(),E("umap",await x.umap.fetchResults())})).catch((e=>{console.error(e),R(t,e,w)}));else if("getAnnotation"===t)H.then((e=>{let t,s,n=r.annotation;if(t=U(n,!!r.unfiltered),ArrayBuffer.isView(t))s={type:"array",values:t.slice()};else{let e=[],r={},n=new Int32Array(t.length);t.map(((t,s)=>{t in r||(r[t]=e.length,e.push(t)),n[s]=r[t]})),s={type:"factor",index:n,levels:e}}let o=[];v(s,o),postMessage({type:"setAnnotation",resp:{annotation:n,values:s},msg:"Success: GET_ANNOTATION done"},o)})).catch((e=>{console.error(e),R(t,e,w)}));else if("computeFeaturesetSummary"===t)H.then((async e=>{let t,{annotation:s,rank_type:n,cluster:a}=r,i=n.indexOf("-");if(M===s)t=x.feature_set_enrichment.computeEnrichment(x.marker_detection.fetchResults().RNA,a,n.slice(0,i),n.slice(i+1)),E("computeFeaturesetSummary",t);else if(k===s){let e=x.custom_selections.fetchSelectionIndices(a),r=x.cell_filtering.fetchFilteredMatrix().numberOfColumns(),c=new Uint8Array(r);e.map((e=>c.set([1],e)));let l=o.Yh(c),u=z(s,l).fetchResults().RNA;t=x.feature_set_enrichment.computeEnrichment(u,l.levels.indexOf(1),n.slice(0,i),n.slice(i+1)),E("computeFeaturesetSummary",t)}else{let e=o.Yh(U(s)),r=z(s,e).fetchResults().RNA;t=x.feature_set_enrichment.computeEnrichment(r,e.levels.indexOf(a),n.slice(0,i),n.slice(i+1)),E("computeFeaturesetSummary",t)}})).catch((e=>{console.error(e),R(t,e,w)}));else if("computeFeaturesetVSSummary"===t)H.then((async e=>{let t,{annotation:s,rank_type:n,left:a,right:i}=r,c=n.indexOf("-");if(M===s){let e=x.marker_detection.computeVersus(a,i);t=x.feature_set_enrichment.computeEnrichment(e.results.RNA,e.left,n.slice(0,c),n.slice(c+1)),E("computeFeaturesetVSSummary",t)}else if(k===s){let e=x.custom_selections.computeVersus(a,i);t=x.feature_set_enrichment.computeEnrichment(e.results.RNA,0,n.slice(0,c),n.slice(c+1)),E("computeFeaturesetVSSummary",t)}else{let e=o.Yh(U(s)),a=z(s,e).computeVersus(e.levels.indexOf(r.left),e.levels.indexOf(r.right));t=x.feature_set_enrichment.computeEnrichment(a.results.RNA,a.left,n.slice(0,c),n.slice(c+1)),E("computeFeaturesetVSSummary",t)}})).catch((e=>{console.error(e),R(t,e,w)}));else if("getFeatureScores"===t)H.then((e=>{let{index:t}=r;E("setFeatureScores",x.feature_set_enrichment.computePerCellScores(t))})).catch((e=>{console.error(e),R(t,e,w)}));else if("getFeatureGeneIndices"===t)H.then((e=>{let t,s,{index:a,cluster:i,annotation:c,modality:l,rank_type:u}=r,f=x.feature_set_enrichment.fetchFeatureSetIndices(a);if(M===c)t=x.marker_detection.fetchResults()[l],s=n.jJ(t,i,u);else if(k===c)t=x.custom_selections.fetchResults(r.cluster)[r.modality],s=n.jJ(t,1,r.rank_type);else{let e=o.Yh(U(c));t=z(c,e).fetchResults()[l],s=n.jJ(t,e.levels.indexOf(i),u)}let d=s.ordering.map(((e,t)=>f.includes(e)?t:-100)).filter((e=>-100!==e)),m={};for(const[r,n]of Object.entries(s))m[r]=n.map(((e,t)=>d.includes(t)?e:-100)).filter((e=>-100!==e));E("setFeatureGeneIndices",m)})).catch((e=>{console.error(e),R(t,e,w)}));else if("computeCellAnnotation"===t){let{annotation:e,cluster:t}=r,s={per_reference:{}},n=null;if(M===e)n=x.marker_detection.fetchResults();else if(k===e)n=x.custom_selections.fetchResults(t);else{n=z(e,o.Yh(U(e))).fetchResults()}null!==n&&"RNA"in n&&(s=x.cell_labelling.computeLabels(n.RNA)),E("computeCellAnnotation",s)}else console.error("Type: ".concat(t," not defined")),R(t,"Type: ".concat(t," not defined"),w)}}},t={};function r(s){var n=t[s];if(void 0!==n)return n.exports;var o=t[s]={id:s,loaded:!1,exports:{}};return e[s].call(o.exports,o,o.exports,r),o.loaded=!0,o.exports}r.m=e,r.x=()=>{var e=r.O(void 0,[86,477,797],(()=>r(9612)));return e=r.O(e)},(()=>{var e=[];r.O=(t,s,n,o)=>{if(!s){var a=1/0;for(u=0;u<e.length;u++){s=e[u][0],n=e[u][1],o=e[u][2];for(var i=!0,c=0;c<s.length;c++)(!1&o||a>=o)&&Object.keys(r.O).every((e=>r.O[e](s[c])))?s.splice(c--,1):(i=!1,o<a&&(a=o));if(i){e.splice(u--,1);var l=n();void 0!==l&&(t=l)}}return t}o=o||0;for(var u=e.length;u>0&&e[u-1][2]>o;u--)e[u]=e[u-1];e[u]=[s,n,o]}})(),r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var s in t)r.o(t,s)&&!r.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce(((t,s)=>(r.f[s](e,t),t)),[])),r.u=e=>"static/js/"+e+"."+{86:"ac3d5bbd",477:"ad1d02d7",484:"8c953ff9",797:"d85810f9",909:"5e5ec0f8",933:"c53a8112"}[e]+".chunk.js",r.miniCssF=e=>{},r.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),r.p="/kana/",(()=>{r.b=self.location+"/../../../";var e={612:1};r.f.i=(t,s)=>{e[t]||importScripts(r.p+r.u(t))};var t=self.webpackChunkkana=self.webpackChunkkana||[],s=t.push.bind(t);t.push=t=>{var n=t[0],o=t[1],a=t[2];for(var i in o)r.o(o,i)&&(r.m[i]=o[i]);for(a&&a(r);n.length;)e[n.pop()]=1;s(t)}})(),(()=>{var e=r.x;r.x=()=>Promise.all([86,477,797].map(r.e,r)).then(e)})();r.x()})();
//# sourceMappingURL=612.96f15464.chunk.js.map