(()=>{"use strict";var e={2866:(e,t,r)=>{var n,s=r(1522),o=r(7990),a=null;function i(){var e=n.result.transaction(["analysis_meta"],"readonly").objectStore("analysis_meta").getAll();return new Promise((t,r)=>{e.onsuccess=r=>{let n=e.result;n.forEach(e=>{delete e.files}),t(n)},e.onerror=e=>{r(new Error("failed to query the analysis store in KanaDB: ".concat(e.target.errorCode)))}})}async function c(){return await a,i()}async function l(e){await a;let t=n.result.transaction(["file"],"readonly").objectStore("file"),r=new Promise((r,n)=>{let s=t.get(e);s.onsuccess=e=>{r(void 0!==s.result?s.result:null)},s.onerror=t=>{n(new Error("failed to retrieve file ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}});var s=await r;return null!==s&&(s=new Uint8Array(s.payload)),s}async function u(e){let t=await e;if(t instanceof Array){let e=[];for(const r of t)e.push(await u(r));t=e}return t}function f(e,t,r){let n=r.get(e);return new Promise((s,o)=>{n.onsuccess=o=>{let a=n.result;var i=a.count-1,c=[];0===i?(c.push(new Promise((r,n)=>{let s=t.delete(e);s.onsuccess=e=>{r(!0)},s.onerror=t=>{n(new Error("failed to remove file ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}})),c.push(new Promise((t,n)=>{let s=r.delete(e);s.onsuccess=e=>{t(!0)},s.onerror=t=>{n(new Error("failed to remove file metadata ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}}))):c.push(new Promise((t,n)=>{a.count=i;let s=r.put(a);s.onsuccess=e=>{t(!0)},s.onerror=t=>{n(new Error("failed to update file metadata ".concat(e," in KanaDB: ").concat(t.target.errorCode)))}})),s(c)},n.onerror=t=>{o(new Error("failed to retrieve file metadata ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}})}var m,d=r(8166),p=r(4441),h=r(519),y=null;async function w(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;try{const r=await async function(e,t,r,n){let s,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if(s=null==o?await fetch(e):await fetch(e,o),!s.ok)throw new Error("oops, failed to download '"+e+"'");const a=t(s.headers.get("content-length")),i=s.body.getReader(),c=[];let l=0;for(;;){const{done:e,value:t}=await i.read();if(e)break;c.push(t),l+=t.length,r(a,l)}let u=new Uint8Array(l),f=0;for(const m of c)u.set(m,f),f+=m.length;return n(a,l),u}(e,t=>(postMessage({type:"DOWNLOAD for url: "+String(e),download:"START",url:String(e),total_bytes:String(t),msg:"Total size is "+String(t)+" bytes!"}),e),(t,r)=>{postMessage({type:"DOWNLOAD for url: "+String(e),download:"PROGRESS",url:String(e),downloaded_bytes:String(r),msg:"Progress so far, got "+String(r)+" bytes!"})},(t,r)=>{postMessage({type:"DOWNLOAD for url: "+String(e),download:"COMPLETE",url:String(e),msg:"Finished, got "+String(r)+" bytes!"})},t);return r}catch(s){let o;postMessage({type:"DOWNLOAD for url: "+String(e),download:"START",url:String(e),total_bytes:100}),o=null==t?fetch(e):fetch(e,t);var r=await o;if(!r.ok)throw new Error("failed to download '"+e+"' ("+r.status+")");var n=await r.arrayBuffer();return postMessage({type:"DOWNLOAD for url: "+String(e),download:"COMPLETE",url:String(e)}),new Uint8Array(n)}}async function g(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(await y,!r){let t=m.result.transaction(["downloads"],"readonly").objectStore("downloads");var n=new Promise((r,n)=>{var s=t.get(e);s.onsuccess=e=>{void 0!==s.result?r(s.result.payload):r(null)},s.onerror=t=>{n("failed to query DownloadsDB for ".concat(e,": ").concat(t.target.errorCode))}}),s=await n;if(null!==s)return s}var o=await w(e,t);let a=m.result.transaction(["downloads"],"readwrite"),i=new Promise((t,r)=>{a.oncomplete=e=>{t(null)},a.onerror=t=>{r(new Error("transaction error for saving ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}}),c=a.objectStore("downloads"),l=new Promise((t,r)=>{var n=c.put({url:e,payload:o});n.onsuccess=e=>{t(!0)},n.onerror=t=>{r(new Error("failed to cache ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}});return await l,await i,o}var _=r(6159),S=r.n(_);const b="https://cors-proxy.aaron-lun.workers.dev";async function O(e){let t=await g(b+"/"+encodeURIComponent(e));return new Uint8Array(t)}function v(e,t){if(e)if(Array.isArray(e))for(const r of e)v(r,t);else if(e.constructor==Object)for(const[r,n]of Object.entries(e))v(n,t);else if(ArrayBuffer.isView(e)){if(!(e.buffer instanceof ArrayBuffer))throw"only ArrayBuffers should be in the message payload";t.push(e.buffer)}}function E(e){postMessage({type:"".concat(e,"_START")})}function R(e,t){if("undefined"==typeof t)postMessage({type:"".concat(e,"_CACHE")});else{var r=[];v(t,r),postMessage({type:"".concat(e,"_DATA"),resp:t},r)}}function A(e,t,r){postMessage({type:"".concat(e,"_ERROR"),resp:{reason:t.toString(),fatal:r}})}function D(e,t,r){for(var n={},s=r.slice(),o=0;o<t.length;o++){let r={};for(const[t,n]of Object.entries(e))r[t]=n.slice().filter((e,t)=>s[t]==o);n[t[o]]=r}return n}function C(e,t){var r={};for(const s of t)r[s]={};for(const[s,o]of Object.entries(e))for(var n=0;n<t.length;n++)r[t[n]][s]=o[n];return r}function k(e){return Array.isArray(e)||ArrayBuffer.isView(e)}function P(e){let t,{all:r=!1,unique:n=!1,colname:o=null}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(k(e)){t=s.hp(e);const a=new Set(e);t.num_unique=a.size,a.size<=50&n&&(t.values=[...a].sort()),r&&(t._all_=e),"continuous"===t.type&&a.size<=50&&(t.type="both"),("string"===typeof o||o instanceof String)&&(t.name=o)}return t}function M(e,t,r){var n;r&&void 0!==r||(r="cohen-min-rank");{let o,a,i=!1;if(r.match(/-mean$/))o="mean";else if(r.match(/-min$/))o="minimum";else{if(!r.match(/-min-rank$/))throw"unknown rank type '"+r+"'";o="min-rank",i=!0}if(r.match(/^cohen-/))a=e.cohensD(t,{summary:o,copy:!1});else if(r.match(/^auc-/))a=e.auc(t,{summary:o,copy:!1});else if(r.match(/^lfc-/))a=e.deltaMean(t,{summary:o,copy:!1});else{if(!r.match(/^delta-d-/))throw"unknown rank type '"+r+"'";a=e.deltaDetected(t,{summary:o,copy:!1})}n=new Int32Array(a.length);for(var s=0;s<n.length;s++)n[s]=s;i?n.sort((e,t)=>a[e]-a[t]):n.sort((e,t)=>a[t]-a[e])}var o=function(e){for(var t=new Float64Array(e.length),r=0;r<n.length;r++)t[r]=e[n[r]];return t},a=o(e.mean(t,{copy:!1})),i=o(e.detected(t,{copy:!1})),c=o(e.deltaMean(t,{summary:"mean",copy:!1})),l=o(e.deltaDetected(t,{summary:"mean",copy:!1}));return{ordering:n,means:a,detected:i,lfc:c,delta_detected:l}}s.Ug.setDownload(O),d.Iy(O),s.Zx.setDownload(O),d.uN(async(e,t,r)=>{let n=d.Az()+"/"+e,s=b+"/"+encodeURIComponent(n);if(null==t&&null==r){let e=await g(s);return new Response(e)}return fetch(s+"?start="+String(t)+"&end="+String(r))}),d.iC(async e=>{let t=d.oc()+"/"+e,r=await g(b+"/"+encodeURIComponent(t));return new Response(r)}),h.az.setDownloadFun(O),s.uw.ExperimentHub=h.az,s.uw.gypsum=h.az;r(4080);const x="K@\ud835\udf02a#$c3ll";"".concat(x,"::CLUSTERS"),"".concat(x,"::SELECTION");const T="".concat(x,"::CLUSTERS"),N="".concat(x,"::SELECTION");let j=null,B={},F={},I=null,z={};function K(e){let t;if("10X"===e.format)t=new s.Fp(e.h5);else if("MatrixMarket"===e.format)t=new s.f8(e.mtx,e.genes||null,e.annotations||null);else if("H5AD"===e.format)t=new s.F6(e.h5);else if("SummarizedExperiment"===e.format)t=new s.dn(e.rds);else if("ZippedADB"===e.format)t=e.ziplegacy?new s.Pm(e.zipname,e.zipfile):new s.kA(e.zipname,e.zipfile);else{if("ExperimentHub"!==e.format)throw new Error("unknown format '"+e.format+"'");t=new h.az("scRNAseq",e.id,q[e.id],null)}return e.options&&t.setOptions(e.options),t}function L(e,t){let r={};for(const s of e.cells.columnNames()){const t=e.cells.column(s);k(t)&&(r[s]=P(t,{all:!0,unique:!0,colname:s}))}let n={cells:{columns:r,numberOfCells:e.cells.numberOfRows()}};if("H5AD"===t.format){n.all_features={};let t={};for(const r of e.all_features.columnNames()){const n=e.all_features.column(r);k(n)&&(t[r]=P(n,{all:!0,unique:!0,colname:r}))}n.all_features={columns:t,numberOfFeatures:e.all_features.numberOfRows(),rownames:Array.isArray(e.all_features.rowNames())}}else if("SummarizedExperiment"===t.format){if(n.modality_features={},"modality_features"in e)for(const[s,o]of Object.entries(e.modality_features)){let e={};for(const t of o.columnNames()){const r=o.column(t);k(r)&&(e[t]=P(r,{all:!0,unique:!0,colname:t}))}n.modality_features[s]={columns:e,numberOfFeatures:o.numberOfRows(),rownames:Array.isArray(o.rowNames())}}}else if(n.modality_features={},"modality_features"in e)for(const[s,o]of Object.entries(e.modality_features)){let e={};for(const t of o.columnNames()){const r=o.column(t);k(r)&&(e[t]=P(r,{all:!0,unique:!0,colname:t}))}n.modality_features[s]={columns:e,numberOfFeatures:o.numberOfRows(),rownames:Array.isArray(o.rowNames())}}return"H5AD"===t.format?n.all_assay_names=e.all_assay_names:"SummarizedExperiment"!==t.format&&"ZippedADB"!==t.format&&"ExperimentHub"!==t.format||(n.modality_assay_names=e.modality_assay_names),n}async function U(e){try{let t=await async function(e,t){if(e[t].changed){if("inputs"===t){let r={},s={};for(const n of e[t].fetchCountMatrix().available())s[n]=e[t].fetchCountMatrix().get(n).numberOfRows();let o={};for(const[n,i]of Object.entries(e[t].fetchFeatureAnnotations())){let e={};for(const t of i.columnNames()){let r=i.column(t);Array.isArray(r)&&(e[t]=r)}Array.isArray(i.rowNames())&&(e.rownames=i.rowNames()),o[n]=e}let a={};for(const n of e[t].fetchCellAnnotations().columnNames()){let r=e[t].fetchCellAnnotations().column(n);if(k(r)){const e=P(r,{all:!1,unique:!0,colname:n});a[n]=e}}if(null!==(n=e[t].fetchBlockLevels())){const r=e[t].fetchBlock().slice();if(k(r)){const e=P(r,{all:!1,unique:!0,colname:"__batch__"});a.__batch__=e}}return r={num_cells:e[t].fetchCountMatrix().numberOfColumns(),num_genes:s,genes:o,annotations:a},r}if("rna_quality_control"===t){let r={sums:e[t].fetchMetrics().sum(),detected:e[t].fetchMetrics().detected(),proportion:e[t].fetchMetrics().subsetProportion(0)},s={};if(null===(n=e.inputs.fetchBlockLevels()))n=["default"],s.data={default:r};else{let t=e.inputs.fetchBlock();s.data=D(r,n,t)}let o={sums:e[t].fetchFilters().sum(),detected:e[t].fetchFilters().detected(),proportion:e[t].fetchFilters().subsetProportion(0)};return s.thresholds=C(o,n),s}if("adt_quality_control"===t){let s={sums:e[t].fetchMetrics().sum(),detected:e[t].fetchMetrics().detected(),proportion:e[t].fetchMetrics().subsetSum(0)};var r={};if(null===(n=e.inputs.fetchBlockLevels()))n=["default"],r.data={default:s};else{let t=e.inputs.fetchBlock();r.data=D(s,n,t)}let o={detected:e[t].fetchFilters().detected(),proportion:e[t].fetchFilters().subsetSum(0)};r.thresholds=C(o,n);for(const[e,t]of Object.entries(r.thresholds))t.sums=NaN;return r}if("crispr_quality_control"===t){let r={sums:e[t].fetchMetrics().sum(),detected:e[t].fetchMetrics().detected(),proportion:e[t].fetchMetrics().maxProportion()},s={};var n;if(null===(n=e.inputs.fetchBlockLevels()))n=["default"],s.data={default:r};else{let t=e.inputs.fetchBlock();s.data=D(r,n,t)}let o={count:e[t].fetchFilters().maxValue(0)};return s.thresholds=C(o,n),s}if("cell_filtering"===t){let r=0,n=null;const s=e[t].fetchKeep();return s?(s.forEach(e=>{r+=0!=e}),n=s.slice()):r=e.inputs.fetchCountMatrix().numberOfColumns(),{retained:r,keep:n}}if("rna_normalization"===t)return{};if("adt_normalization"===t)return{};if("crispr_normalization"===t)return{};if("feature_selection"===t)return{means:e[t].fetchResults().means(),vars:e[t].fetchResults().variances(),fitted:e[t].fetchResults().fitted(),resids:e[t].fetchResults().residuals()};if("rna_pca"===t||"adt_pca"===t||"crispr_pca"===t){let r=e[t].fetchPCs();var s=r.varianceExplained(),o=r.totalVariance();return s.forEach((e,t)=>{s[t]=e/o}),{var_exp:s}}if("combine_embeddings"===t)return{};if("batch_correction"===t)return{};if("neighbor_index"===t)return{};if("tsne"===t||"umap"===t)return await e[t].fetchResults();if("kmeans_cluster"===t)return{};if("snn_graph_cluster"===t)return{};if("choose_clustering"===t)return{clusters:e[t].fetchClusters().slice()};if("marker_detection"===t)return{};if("cell_labelling"===t){let r=e.marker_detection.fetchResults();return"RNA"in r?e[t].computeLabels(r.RNA):{per_reference:{}}}if("custom_selections"===t)return{};if("feature_set_enrichment"===t){let t=e.feature_set_enrichment.fetchCollectionDetails(),r=e.feature_set_enrichment.fetchSetDetails();return{collections:t,sets:{names:r.names,descriptions:r.descriptions,sizes:r.sizes.slice(),collections:r.collections.slice()}}}}}(j,e);R(e,t)}catch(t){console.error(t),A(e,t,!0)}}function V(e,t){let r;return e in z||(r=new s.Jk(G(),t.ids.slice()),r.computeAll(),z[e]=r),z[e]}s.cf((e,t,r,n)=>{postMessage({type:e+"_iter",x:t,y:r,iteration:n},[t.buffer,r.buffer])}),s.v9(l);const H=function(e){let t,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if("__batch__"===e)t=j.inputs.fetchBlock().slice();else if(e.startsWith("".concat(x,"::QC::"))){let r=e.replace("".concat(x,"::QC::"),"").split("_"),n=j["".concat(r[0].toLowerCase(),"_quality_control")].fetchMetrics();"sums"===r[1]?t=n.sum():"detected"===r[1]?t=n.detected():"proportion"===r[1]&&("rna"===r[0].toLowerCase()?t=n.subsetProportion(0):"adt"===r[0].toLowerCase()?t=n.subsetSum(0):"crispr"===r[0].toLowerCase()&&(t=n.maxProportion(0)))}else t=j.inputs.fetchCellAnnotations().column(e);return r||(t=j.cell_filtering.applyFilter(t)),t.slice()},G=()=>{if(null===I){I=new o.P_;let e={RNA:"rna_normalization",ADT:"adt_normalization",CRISPR:"crispr_normalization"};for(const[t,r]of Object.entries(e)){let e=j[r];e.valid()&&I.add(t,e.fetchNormalizedMatrix())}}return I},q={"zeisel-brain-2015":"2023-12-14","segerstolpe-pancreas-2016":"2023-12-19","nestorowa-hsc-2016":"2024-04-18","aztekin-tail-2019":"2023-12-14","wu-kidney-2019":"2023-12-20","zilionis-lung-2019":"2023-12-20"};var $;onmessage=function(e){const{type:t,payload:r}=e.data;let h=!1;if("INIT"===t){h=!0;let e=Math.round(2*navigator.hardwareConcurrency/3),r=s.n_({numberOfThreads:e}),o=r.then(()=>s.fc());o.then(e=>{j=e,postMessage({type:t,msg:"Success: analysis state created"})});let c=a=new Promise(e=>{(n=indexedDB.open("KanaDB",2)).onupgradeneeded=e=>{var t=e.target.result;try{t.deleteObjectStore("analysis")}catch(e){}try{t.deleteObjectStore("analysis_meta")}catch(e){}try{t.deleteObjectStore("file")}catch(e){}try{t.deleteObjectStore("file_meta")}catch(e){}t.createObjectStore("analysis",{keyPath:"id"}),t.createObjectStore("analysis_meta",{keyPath:"id"}),t.createObjectStore("file",{keyPath:"id"}),t.createObjectStore("file_meta",{keyPath:"id"})},n.onsuccess=()=>{e(i())},n.onerror=()=>{e(null)}});c.then(e=>{null!==e&&postMessage({type:"KanaDB_store",resp:e,msg:"Success: KanaDB initialized"})}).catch(e=>{console.error(e),postMessage({type:"KanaDB_ERROR",msg:"Error: Cannot initialize KanaDB"})});let l=(null===y&&(y=new Promise((e,t)=>{(m=indexedDB.open("DownloadsDB",3)).onupgradeneeded=e=>{var t=e.target.result;try{t.deleteObjectStore("downloads")}catch(e){}t.createObjectStore("downloads",{keyPath:"url"})},m.onsuccess=()=>{e(null)},m.onerror=()=>{t("failed to initialize DownloadsDB")}})),y);l.then(e=>{postMessage({type:"DownloadsDB_store",resp:e,msg:"Success: DownloadsDB initialized"})}).catch(e=>{console.error(e),postMessage({type:"DownloadsDB_ERROR",msg:"Error: Cannot initialize DownloadsDB"})});try{postMessage({type:"ExperimentHub_store",resp:Array.from(Object.keys(q)),msg:"Success: ExperimentHub initialized"})}catch(_){console.error(_),postMessage({type:"ExperimentHub_ERROR",msg:"Error: Cannot access datasets in ExperimentHub"})}($=Promise.all([r,c,l,o])).then(()=>{postMessage({type:t,msg:"Success: bakana initialized"})}).catch(e=>{console.error(e),A(t,e,h)})}else if("RUN"===t)h=!0,$.then(e=>{let n=r.inputs,o=n.files;if(null!==o){let e={};for(const[t,r]of Object.entries(o))"uid"in r&&r.uid in B?e[t]=B[r.uid]:e[t]=K(r),e[t].setOptions(r.options);for(const[t,r]of Object.entries(B))r.clear(),delete B[t];o=e}(()=>{for(const[e,t]of Object.entries(z))t.free();z={}})();let a=function(e,t){let r=t,n=(e,t,n)=>{if("undefined"==typeof n)throw new Error("cannot assign undefined parameter to '"+e+"."+t+"'");if(!(e in r))throw new Error("unknown analysis step '"+e+"'");let s=r[e];if(!(t in s))throw new Error("unknown analysis parameter '"+t+"' for step '"+e+"'");s[t]=n};n("inputs","block_factor",e.batch),n("inputs","subset",e.subset),s.nL(r,t.batch_correction.method),s.OD(r,t.neighbor_index.approximate),null!==r.combine_embeddings.weights&&new Set([r.combine_embeddings.rna_weight,r.combine_embeddings.adt_weight,r.combine_embeddings.crispr_weight]).size<=1&&(r.combine_embeddings.weights=null);return r}(n,r.params);s.A1(j,o,a,{startFun:E,finishFun:U}).catch(e=>{console.error(e),A(t,e,h)})}).catch(e=>{console.error(e),A(t,e,h)});else if("LOAD"===t){h=!0;let e=r.inputs.files;if("kana"===e[Object.keys(e)[0]].format){let r=e[Object.keys(e)[0]].file;$.then(async e=>{const t=(new FileReaderSync).readAsArrayBuffer(r),n=await S().loadAsync(t);let o=JSON.parse(await n.file("config.json").async("string")),a={};for(const r in n.files)if(r.startsWith("datasets/")){let e=await n.files[r].async("uint8array");a[r.split("/")[1]]=e}j=await s.SR(o,e=>a[e],{state:j,startFun:E,finishFun:U});const i={custom_selections:j.custom_selections.fetchSelections()};var c=[];v(o.parameters,c),postMessage({type:"loadedParameters",resp:{parameters:o.parameters,other:i}},c);let l={},u={};const f=j.inputs.fetchDatasets();for(const[r,s]of Object.entries(f)){let e=await s.previewPrimaryIds({cache:!0});for(const t of["RNA","ADT","CRISPR"])t in e&&(l[t]?l[t].push(e[t]):l[t]=[e[t]])}for(const[r,s]of Object.entries(l))u[r]=d.y$(s).length;postMessage({type:"PREFLIGHT_OPTIONS_DATA",resp:u,msg:"Success: PREFLIGHT_OPTIONS done"})}).catch(e=>{console.error(e),A(t,e,h)})}else"kanadb"===e[Object.keys(e)[0]].format&&$.then(async t=>{var r=e[Object.keys(e)[0]].file;const o=await async function(e){await a;let t=n.result.transaction(["analysis"],"readonly").objectStore("analysis"),r=new Promise((r,n)=>{let s=t.get(e);s.onsuccess=e=>{r(void 0!==s.result?s.result:null)},s.onerror=t=>{n(new Error("failed to retrieve analysis ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}});var s=await r;return null!==s&&(s=new Uint8Array(s.payload)),s}(r),i=new TextDecoder;let c=JSON.parse(i.decode(o));j=await s.SR(c,l,{state:j,startFun:E,finishFun:U})}).catch(e=>{console.error(e),A(t,e,h)})}else if("EXPORT"===t)$.then(async e=>{let t=[],r=await s.hO(j,(e,r,n)=>{let s=String(t.length);return t.push(n.buffer()),s});const n=new(S());n.file("config.json",JSON.stringify(r));for(var o=0;o<t.length;o++)n.file("datasets/"+String(o),t[o]);let a=await n.generateAsync({type:"uint8array"});postMessage({type:"exportState",resp:a,msg:"Success: application state exported"},[a.buffer])}).catch(e=>{console.error(e),A(t,e,h)});else if("EXPORT_RDS"===t)$.then(async e=>{let t=await s.JH(j,"sce"),r=await s.DV(j,null),n=new(S());for(const[s,a]of Object.entries(t))n.file(s,a);for(const[s,a]of Object.entries(r))n.file(s,a);let o=await n.generateAsync({type:"uint8array",compression:"DEFLATE"});postMessage({type:"exportRDSState",resp:o,msg:"Success: application state exported"},[o.buffer])}).catch(e=>{console.error(e),A(t,e,h)});else if("SAVEKDB"===t){var w=r.title;$.then(async e=>{let r=[],o=await s.hO(j,async(e,s,o)=>{let i=o.buffer();var c=await p.Fx(i),l=t+"_"+o.name()+"_"+i.length+"_"+c;return await async function(e,t){await a;let r=n.result.transaction(["file","file_meta"],"readwrite"),s=new Promise((t,n)=>{r.oncomplete=e=>{t(null)},r.onerror=t=>{n(new Error("transaction error when saving file ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}}),o=r.objectStore("file"),i=r.objectStore("file_meta"),c=i.get(e),l=new Promise((r,n)=>{c.onsuccess=n=>{let s=c.result;"undefined"===typeof s?s={count:1,id:e}:s.count++;var a=new Promise((r,n)=>{var s=o.put({id:e,payload:t.buffer});s.onsuccess=e=>{r(!0)},s.onerror=t=>{n(new Error("failed to save file ".concat(e," in KanaDB: ").concat(t.target.errorCode)))}}),l=new Promise((t,r)=>{var n=i.put(s);n.onsuccess=e=>{t(!0)},n.onerror=t=>{r(new Error("failed to save metadata for file ".concat(e," in KanaDB: ").concat(t.target.errorCode)))}});r(Promise.all([a,l]))},c.onerror=t=>{n(new Error("failed to retrieve metadata ".concat(e," in KanaDB: ").concat(t.target.errorCode)))}});await s,await l}(l,i),r.push(l),l});let i=(new TextEncoder).encode(JSON.stringify(o)),l=await async function(e,t,r,s){await a;let o,i=n.result.transaction(["analysis","analysis_meta"],"readwrite"),c=new Promise((t,r)=>{i.oncomplete=e=>{t(null)},i.onerror=t=>{r(new Error("transaction error when saving analysis ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}}),l=i.objectStore("analysis"),u=i.objectStore("analysis_meta"),f=e=>{var n=new Promise((r,n)=>{var s=l.put({id:e,payload:t.buffer});s.onsuccess=e=>{r(!0)},s.onerror=t=>{n(new Error("failed to save analysis file ".concat(e," in KanaDB: ").concat(t.target.errorCode)))}}),o=new Promise((t,n)=>{var o=u.put({id:e,files:r,time:Number(new Date),title:s});o.onsuccess=e=>{t(!0)},o.onerror=t=>{n(new Error("failed to save analysis metadata ".concat(e," in KanaDB: ").concat(t.target.errorCode)))}});return[e,n,o]};if(null===e){let e=u.getAll();o=new Promise((t,r)=>{e.onsuccess=r=>{t(f(String(e.result.length)))},e.onerror=e=>{r(new Error("failed to list existing analysis store in KanaDB: ".concat(e.target.errorCode)))}})}else o=f(e);let m=await o;return await c,m[0]}(null,i,o,w),u=await c();postMessage({type:"KanaDB_store",resp:u,msg:"Success: Saved analysis to browser (".concat(l,")")})}).catch(e=>{console.error(e),A(t,e,h)})}else if("REMOVEKDB"===t){var g=r.id;(async function(e){await a;let t=n.result.transaction(["analysis","analysis_meta","file","file_meta"],"readwrite"),r=new Promise((r,n)=>{t.oncomplete=e=>{r(null)},t.onerror=t=>{n(new Error("transaction error when removing analysis ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}}),s=t.objectStore("analysis"),o=t.objectStore("analysis_meta"),i=t.objectStore("file"),c=t.objectStore("file_meta"),l=new Promise((t,r)=>{let n=s.delete(e);n.onsuccess=e=>{t(!0)},n.onerror=t=>{r(new Error("failed to delete analysis ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}}),m=o.get(e),d=new Promise((t,r)=>{m.onsuccess=r=>{let n=m.result,s=[];for(const e of Object.values(n.files.datasets))for(const t of e.files)s.push(f(t.id,i,c));let a=new Promise((t,r)=>{let n=o.delete(e);n.onsuccess=e=>{t(!0)},n.onerror=t=>{r(new Error("failed to delete analysis metadata ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}});s.push(a),t(s)},m.onerror=t=>{r(new Error("failed to retrieve analysis metadata ".concat(e," from KanaDB: ").concat(t.target.errorCode)))}});return await l,await u(d),await r,!0})(g).then(async e=>{let t=await c();postMessage({type:"KanaDB_store",resp:t,msg:"Success: Removed file from cache (".concat(g,")")})}).catch(e=>{console.error(e),A(t,e,h)})}else if("PREFLIGHT_OPTIONS"===t)$.then(async e=>{let t={};try{let e=0,n={};for(const[t,s]of Object.entries(r.inputs.files)){if("uid"in s){let t=B[s.uid];if(Array.isArray(r.options)&&r.options.length>e){t.setOptions(r.options[e]);let s=await t.previewPrimaryIds({cache:!0});for(const e of["RNA","ADT","CRISPR"])e in s&&(n[e]?n[e].push(s[e]):n[e]=[s[e]])}}e++}for(const[s,o]of Object.entries(n))o.length!==r.options.length?t[s]=0:t[s]=d.y$(o).length}catch(n){console.error(n),t.status="ERROR",t.reason=n.toString()}postMessage({type:"PREFLIGHT_OPTIONS_DATA",resp:t,msg:"Success: PREFLIGHT_OPTIONS done"})});else if("PREFLIGHT_INPUT"===t)$.then(async e=>{let t={};try{let e={},n={};for(const[t,s]of Object.entries(r.inputs.files))if("uid"in s)s.uid in B||(B[s.uid]=K(s),F[s.uid]=await B[s.uid].summary({cache:!0})),e[t]=B[s.uid],n[t]=L(F[s.uid],s);else{let r=K(s);e[t]=r,n[t]=L(await e[t].summary({cache:!0}),s)}t.status="SUCCESS",t.details=n}catch(n){console.error(n),t.status="ERROR",t.reason=n.toString()}postMessage({type:"PREFLIGHT_INPUT_DATA",resp:t,msg:"Success: PREFLIGHT_INPUT done"})}).catch(e=>{console.error(e),A(t,e,h)});else if("computeVersusClusters"===t)$.then(e=>{let t,n,s=r.rank_type,a=r.modality,i=r.annotation;if(T===i)n=j.marker_detection.computeVersus(r.left,r.right),t=M(n.results[a],n.left,s);else{let e=o.K$(H(i));n=V(i,e).computeVersus(e.levels.indexOf(r.left),e.levels.indexOf(r.right)),t=M(n.results[a],n.left,s)}var c=[];v(t,c),postMessage({type:"computeVersusClusters",resp:t,msg:"Success: COMPUTE_VERSUS_CLUSTERS done"},c)}).catch(e=>{console.error(e),A(t,e,h)});else if("computeVersusSelections"===t)$.then(e=>{let t=r.rank_type,n=j.custom_selections.computeVersus(r.left,r.right),s=M(n.results[r.modality],n.left,t);var o=[];v(s,o),postMessage({type:"computeVersusSelections",resp:s,msg:"Success: COMPUTE_VERSUS_SELECTIONS done"},o)}).catch(e=>{console.error(e),A(t,e,h)});else if("getMarkersForCluster"===t)$.then(e=>{let t,n,s=r.cluster,a=r.rank_type,i=r.modality,c=r.annotation;if(T===c)n=j.marker_detection.fetchResults()[i],t=M(n,s,a);else{let e=o.K$(H(c));n=V(c,e).fetchResults()[i],t=M(n,e.levels.indexOf(s),a)}var l=[];v(t,l),postMessage({type:"setMarkersForCluster",resp:t,msg:"Success: GET_MARKERS_FOR_CLUSTER done"},l)}).catch(e=>{console.error(e),A(t,e,h)});else if("getGeneExpression"===t)$.then(e=>{let t=r.gene,n=r.modality;const s=G(n);let o;if("RNA"===n)o=s.get(n).row(t);else if("ADT"===n)o=s.get(n).row(t);else{if("CRISPR"!==n)throw new Error("unknown feature type '"+n+"'");o=s.get(n).row(t)}postMessage({type:"setGeneExpression",resp:{gene:t,expr:o},msg:"Success: GET_GENE_EXPRESSION done"},[o.buffer])}).catch(e=>{console.error(e),A(t,e,h)});else if("computeCustomMarkers"===t)$.then(e=>{j.custom_selections.addSelection(r.id,r.selection),postMessage({type:"computeCustomMarkers",msg:"Success: COMPUTE_CUSTOM_MARKERS done"})}).catch(e=>{console.error(e),A(t,e,h)});else if("getMarkersForSelection"===t)$.then(e=>{let t=M(j.custom_selections.fetchResults(r.cluster)[r.modality],1,r.rank_type);var n=[];v(t,n),postMessage({type:"setMarkersForCustomSelection",resp:t,msg:"Success: GET_MARKERS_FOR_SELECTION done"},n)}).catch(e=>{console.error(e),A(t,e,h)});else if("removeCustomMarkers"===t)$.then(e=>{j.custom_selections.removeSelection(r.id)}).catch(e=>{console.error(e),A(t,e,h)});else if("animateTSNE"===t)$.then(async e=>{await j.tsne.animate(),R("tsne",await j.tsne.fetchResults())}).catch(e=>{console.error(e),A(t,e,h)});else if("animateUMAP"===t)$.then(async e=>{await j.umap.animate(),R("umap",await j.umap.fetchResults())}).catch(e=>{console.error(e),A(t,e,h)});else if("getAnnotation"===t)$.then(e=>{let t,n,s=r.annotation;if(t=H(s,!!r.unfiltered),ArrayBuffer.isView(t))n={type:"array",values:t.slice()};else{let e=[],r={},s=new Int32Array(t.length);t.map((t,n)=>{t in r||(r[t]=e.length,e.push(t)),s[n]=r[t]}),n={type:"factor",index:s,levels:e}}let o=[];v(n,o),postMessage({type:"setAnnotation",resp:{annotation:s,values:n},msg:"Success: GET_ANNOTATION done"},o)}).catch(e=>{console.error(e),A(t,e,h)});else if("computeFeaturesetSummary"===t)$.then(async e=>{let t,{annotation:n,rank_type:s,cluster:a}=r,i=s.indexOf("-");if(T===n)t=j.feature_set_enrichment.computeEnrichment(j.marker_detection.fetchResults().RNA,a,s.slice(0,i),s.slice(i+1)),R("computeFeaturesetSummary",t);else if(N===n){let e=j.custom_selections.fetchSelectionIndices(a),r=j.cell_filtering.fetchFilteredMatrix().numberOfColumns(),c=new Uint8Array(r);e.map(e=>c.set([1],e));let l=o.K$(c),u=V(n,l).fetchResults().RNA;t=j.feature_set_enrichment.computeEnrichment(u,l.levels.indexOf(1),s.slice(0,i),s.slice(i+1)),R("computeFeaturesetSummary",t)}else{let e=o.K$(H(n)),r=V(n,e).fetchResults().RNA;t=j.feature_set_enrichment.computeEnrichment(r,e.levels.indexOf(a),s.slice(0,i),s.slice(i+1)),R("computeFeaturesetSummary",t)}}).catch(e=>{console.error(e),A(t,e,h)});else if("computeFeaturesetVSSummary"===t)$.then(async e=>{let t,{annotation:n,rank_type:s,left:a,right:i}=r,c=s.indexOf("-");if(T===n){let e=j.marker_detection.computeVersus(a,i);t=j.feature_set_enrichment.computeEnrichment(e.results.RNA,e.left,s.slice(0,c),s.slice(c+1)),R("computeFeaturesetVSSummary",t)}else if(N===n){let e=j.custom_selections.computeVersus(a,i);t=j.feature_set_enrichment.computeEnrichment(e.results.RNA,0,s.slice(0,c),s.slice(c+1)),R("computeFeaturesetVSSummary",t)}else{let e=o.K$(H(n)),a=V(n,e).computeVersus(e.levels.indexOf(r.left),e.levels.indexOf(r.right));t=j.feature_set_enrichment.computeEnrichment(a.results.RNA,a.left,s.slice(0,c),s.slice(c+1)),R("computeFeaturesetVSSummary",t)}}).catch(e=>{console.error(e),A(t,e,h)});else if("getFeatureScores"===t)$.then(e=>{let{index:t}=r;R("setFeatureScores",j.feature_set_enrichment.computePerCellScores(t))}).catch(e=>{console.error(e),A(t,e,h)});else if("getFeatureGeneIndices"===t)$.then(e=>{let t,n,{index:s,cluster:a,annotation:i,modality:c,rank_type:l}=r,u=j.feature_set_enrichment.fetchFeatureSetIndices(s);if(T===i)t=j.marker_detection.fetchResults()[c],n=M(t,a,l);else if(N===i)t=j.custom_selections.fetchResults(r.cluster)[r.modality],n=M(t,1,r.rank_type);else{let e=o.K$(H(i));t=V(i,e).fetchResults()[c],n=M(t,e.levels.indexOf(a),l)}let f=n.ordering.map((e,t)=>u.includes(e)?t:-100).filter(e=>-100!==e),m={};for(const[r,o]of Object.entries(n))m[r]=o.map((e,t)=>f.includes(t)?e:-100).filter(e=>-100!==e);R("setFeatureGeneIndices",m)}).catch(e=>{console.error(e),A(t,e,h)});else if("computeCellAnnotation"===t){let{annotation:e,cluster:t}=r,n={per_reference:{}},s=null;if(T===e)s=j.marker_detection.fetchResults();else if(N===e)s=j.custom_selections.fetchResults(t);else{s=V(e,o.K$(H(e))).fetchResults()}null!==s&&"RNA"in s&&(n=j.cell_labelling.computeLabels(s.RNA)),R("computeCellAnnotation",n)}else console.error("Type: ".concat(t," not defined")),A(t,"Type: ".concat(t," not defined"),h)}}},t={};function r(n){var s=t[n];if(void 0!==s)return s.exports;var o=t[n]={id:n,loaded:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.loaded=!0,o.exports}r.m=e,r.x=()=>{var e=r.O(void 0,[691,985,978],()=>r(2866));return e=r.O(e)},(()=>{var e=[];r.O=(t,n,s,o)=>{if(!n){var a=1/0;for(u=0;u<e.length;u++){for(var[n,s,o]=e[u],i=!0,c=0;c<n.length;c++)(!1&o||a>=o)&&Object.keys(r.O).every(e=>r.O[e](n[c]))?n.splice(c--,1):(i=!1,o<a&&(a=o));if(i){e.splice(u--,1);var l=s();void 0!==l&&(t=l)}}return t}o=o||0;for(var u=e.length;u>0&&e[u-1][2]>o;u--)e[u]=e[u-1];e[u]=[n,s,o]}})(),r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce((t,n)=>(r.f[n](e,t),t),[])),r.u=e=>"static/js/"+e+"."+{120:"568b3440",343:"07177662",691:"9a33b0ff",814:"bc231a0d",978:"92a21f88",985:"b0e597fb"}[e]+".chunk.js",r.miniCssF=e=>{},r.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),r.p="/kana/",(()=>{r.b=self.location+"/../../../";var e={866:1};r.f.i=(t,n)=>{e[t]||importScripts(r.p+r.u(t))};var t=self.webpackChunkkana=self.webpackChunkkana||[],n=t.push.bind(t);t.push=t=>{var[s,o,a]=t;for(var i in o)r.o(o,i)&&(r.m[i]=o[i]);for(a&&a(r);s.length;)e[s.pop()]=1;n(t)}})(),(()=>{var e=r.x;r.x=()=>Promise.all([691,985,978].map(r.e,r)).then(e)})();r.x()})();
//# sourceMappingURL=866.54ed6e6d.chunk.js.map