(()=>{"use strict";var e={2418:(e,t,n)=>{var r,s=n(1522),o=n(7990),a=null;async function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;try{const n=await async function(e,t,n,r){let s,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if(s=null==o?await fetch(e):await fetch(e,o),!s.ok)throw new Error("oops, failed to download '"+e+"'");const a=t(s.headers.get("content-length")),l=s.body.getReader(),i=[];let c=0;for(;;){const{done:e,value:t}=await l.read();if(e)break;i.push(t),c+=t.length,n(a,c)}let u=new Uint8Array(c),f=0;for(const d of i)u.set(d,f),f+=d.length;return r(a,c),u}(e,(t=>(postMessage({type:"DOWNLOAD for url: "+String(e),download:"START",url:String(e),total_bytes:String(t),msg:"Total size is "+String(t)+" bytes!"}),e)),((t,n)=>{postMessage({type:"DOWNLOAD for url: "+String(e),download:"PROGRESS",url:String(e),downloaded_bytes:String(n),msg:"Progress so far, got "+String(n)+" bytes!"})}),((t,n)=>{postMessage({type:"DOWNLOAD for url: "+String(e),download:"COMPLETE",url:String(e),msg:"Finished, got "+String(n)+" bytes!"})}),t);return n}catch(s){let o;postMessage({type:"DOWNLOAD for url: "+String(e),download:"START",url:String(e),total_bytes:100}),o=null==t?fetch(e):fetch(e,t);var n=await o;if(!n.ok)throw new Error("failed to download '"+e+"' ("+n.status+")");var r=await n.arrayBuffer();return postMessage({type:"DOWNLOAD for url: "+String(e),download:"COMPLETE",url:String(e)}),new Uint8Array(r)}}async function i(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(await a,!n){let t=r.result.transaction(["downloads"],"readonly").objectStore("downloads");var s=new Promise(((n,r)=>{var s=t.get(e);s.onsuccess=e=>{void 0!==s.result?n(s.result.payload):n(null)},s.onerror=t=>{r("failed to query DownloadsDB for ".concat(e,": ").concat(t.target.errorCode))}})),o=await s;if(null!==o)return o}var i=await l(e,t);let c=r.result.transaction(["downloads"],"readwrite"),u=new Promise(((t,n)=>{c.oncomplete=e=>{t(null)},c.onerror=t=>{n(new Error("transaction error for saving ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}})),f=c.objectStore("downloads"),d=new Promise(((t,n)=>{var r=f.put({url:e,payload:i});r.onsuccess=e=>{t(!0)},r.onerror=t=>{n(new Error("failed to cache ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}}));return await d,await u,i}var c=n(8166),u=n(9757);const f="https://cors-proxy.aaron-lun.workers.dev";async function d(e){let t=await i(f+"/"+encodeURIComponent(e));return new Uint8Array(t)}function m(e,t){if(e)if(Array.isArray(e))for(const n of e)m(n,t);else if(e.constructor==Object)for(const[n,r]of Object.entries(e))m(r,t);else if(ArrayBuffer.isView(e)){if(!(e.buffer instanceof ArrayBuffer))throw"only ArrayBuffers should be in the message payload";t.push(e.buffer)}}function p(e){postMessage({type:"".concat(e,"_START")})}function y(e,t){if("undefined"==typeof t)postMessage({type:"".concat(e,"_CACHE")});else{var n=[];m(t,n),postMessage({type:"".concat(e,"_DATA"),resp:t},n)}}function h(e,t,n){postMessage({type:"".concat(e,"_ERROR"),resp:{reason:t.toString(),fatal:n}})}function g(e){return Array.isArray(e)||ArrayBuffer.isView(e)}function w(e){let t,{all:n=!1,unique:r=!1,colname:o=null}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(g(e)){t=s.hp(e);const a=new Set(e);t.num_unique=a.size,a.size<=50&r&&(t.values=[...a].sort()),n&&(t._all_=e),"continuous"===t.type&&a.size<=50&&(t.type="both"),("string"===typeof o||o instanceof String)&&(t.name=o)}return t}s.Ug.setDownload(d),c.Iy(d),s.Zx.setDownload(d),c.uN((async(e,t,n)=>{let r=c.Az()+"/"+e,s=f+"/"+encodeURIComponent(r);if(null==t&&null==n){let e=await i(s);return new Response(e)}return fetch(s+"?start="+String(t)+"&end="+String(n))})),c.iC((async e=>{let t=c.oc()+"/"+e,n=await i(f+"/"+encodeURIComponent(t));return new Response(n)})),u.h.setDownloadFun(d),s.uw.ExperimentHub=u.h;n(4080);const S="K@\ud835\udf02a#$c3ll";"".concat(S,"::CLUSTERS"),"".concat(S,"::SELECTION"),"".concat(S,"::CLUSTERS");const O="".concat(S,"::SELECTION");let _=null,E={},v={},b=null,R={},A=null,C=null,M=null;function D(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if("H5AD"===e.format)return new s.U4(e.h5,t?e.options:{});if("SummarizedExperiment"===e.format)return new s.o5(e.rds,t?e.options:{});if("ZippedArtifactdb"===e.format)return new s.m0(e.zipname,new s.VM(e.zipfile),t?e.options:{});throw new Error("unknown format '"+e.format+"'")}function T(e,t){let n={};for(const s of e.cells.columnNames()){const t=e.cells.column(s);g(t)&&(n[s]=w(t,{all:!0,colname:s}))}let r={cells:{columns:n,numberOfCells:e.cells.numberOfRows()}};if("SummarizedExperiment"===t.format||"ZippedArtifactdb"===t.format){if(r.modality_features={},"modality_features"in e)for(const[s,o]of Object.entries(e.modality_features)){let e={};for(const t of o.columnNames()){const n=o.column(t);g(n)&&(e[t]=w(n,{all:!0,colname:t}))}r.modality_features[s]={columns:e,numberOfFeatures:o.numberOfRows(),rownames:Array.isArray(o.rowNames())}}}else{r.all_features={};let t={};for(const n of e.all_features.columnNames()){const r=e.all_features.column(n);g(r)&&(t[n]=w(r,{all:!0,colname:n}))}r.all_features={columns:t,numberOfFeatures:e.all_features.numberOfRows(),rownames:Array.isArray(e.all_features.rowNames())}}return"H5AD"===t.format?r.all_assay_names=e.all_assay_names:"SummarizedExperiment"!==t.format&&"ZippedArtifactdb"!==t.format||(r.modality_assay_names=e.modality_assay_names),r.reduced_dimension_names=e.reduced_dimension_names,r}function x(e,t){let n;return e in R||(n=new s.Jk(N(),t.ids.slice()),n.computeAll(),R[e]=n),R[e]}const k=e=>{if(-1!==e.indexOf(":::")){let t=e.split(":::");return b.cells.column(t[0]).column(t[1])}return b.cells.column(e)},N=()=>b.matrix;var P;onmessage=function(e){const{type:t,payload:n}=e.data;let l=!1;if("INIT"===t){l=!0;let e=Math.round(2*navigator.hardwareConcurrency/3),n=s.n_({numberOfThreads:e}),o=n.then((()=>s.fc()));o.then((e=>{_=e,postMessage({type:t,msg:"Success: analysis state created"})}));let i=(null===a&&(a=new Promise(((e,t)=>{(r=indexedDB.open("DownloadsDB",3)).onupgradeneeded=e=>{var t=e.target.result;try{t.deleteObjectStore("downloads")}catch(e){}t.createObjectStore("downloads",{keyPath:"url"})},r.onsuccess=()=>{e(null)},r.onerror=()=>{t("failed to initialize DownloadsDB")}}))),a);i.then((e=>{postMessage({type:"DownloadsDB_store",resp:e,msg:"Success: DownloadsDB initialized"})})).catch((e=>{console.error(e),postMessage({type:"DownloadsDB_ERROR",msg:"Error: Cannot initialize DownloadsDB"})})),(P=Promise.all([n,o,i])).then((()=>{postMessage({type:t,msg:"Success: bakana initialized"})})).catch((e=>{console.error(e),h(t,e,l)}))}else if("EXPLORE"===t)l=!0,P.then((async e=>{let t=n.inputs.files;if(null!==t){let e={};for(const[n,r]of Object.entries(t))"uid"in r&&r.uid in E&&(E[r.uid].clear(),delete E[n]),e[n]=D(r,!0),e[n].setOptions(r.options);for(const[n,r]of Object.entries(e)){b=await r.load();t[n];let e="inputs";p(e);let o={};for(const t of b.cells.columnNames()){let e=b.cells.column(t);if(g(e)){const n=w(e,{all:!1,unique:!0,colname:t});o[t]=n}}let a={annotations:o,genes:{},num_cells:b.cells.numberOfRows(),num_genes:{}};for(const[t,n]of Object.entries(b.features)){a.genes[t]={},a.num_genes[t]=n.numberOfRows();for(const e of n.columnNames()){let r=n.column(e);g(r)&&(a.genes[t][e]=r)}n.rowNames()&&(a.genes[t].rowNames=n.rowNames())}y(e,a);let l="embedding";p(l);let i={};for(const[t,n]of Object.entries(b.reduced_dimensions))"pca"!==t.toLowerCase()&&(i[t]={x:n[0].slice(),y:n[1].slice()});y(l,i),A&&A.free(),A=new s.g0(b.matrix)}}})).catch((e=>{console.error(e),h(t,e,l)}));else if("PREFLIGHT_INPUT"===t)P.then((async e=>{let t={};try{let e={},r={};for(const[t,s]of Object.entries(n.inputs.files))if("uid"in s)s.uid in E||(E[s.uid]=D(s),v[s.uid]=await E[s.uid].summary()),e[t]=E[s.uid],r[t]=T(v[s.uid],s);else{let n=D(s);e[t]=n,r[t]=T(e[t],s)}t.status="SUCCESS",t.details=r}catch(r){console.error(r),t.status="ERROR",t.reason=r.toString()}postMessage({type:"PREFLIGHT_INPUT_DATA",resp:t,msg:"Success: PREFLIGHT_INPUT done"})})).catch((e=>{console.error(e),h(t,e,l)}));else if("computeVersusClusters"===t)P.then((e=>{let t=n.rank_type,r=n.modality,a=n.annotation,l=o.GO(k(a)),i=x(a,l).computeVersus(l.levels.indexOf(n.left),l.levels.indexOf(n.right)),c=s.at(i.results[r],i.left,t);var u=[];m(c,u),postMessage({type:"computeVersusClusters",resp:c,msg:"Success: COMPUTE_VERSUS_CLUSTERS done"},u)})).catch((e=>{console.error(e),h(t,e,l)}));else if("computeVersusSelections"===t)P.then((e=>{let t=n.rank_type,r=A.computeVersus(n.left,n.right),o=s.at(r.results[n.modality],n.left,t);var a=[];m(o,a),postMessage({type:"computeVersusSelections",resp:o,msg:"Success: COMPUTE_VERSUS_SELECTIONS done"},a)})).catch((e=>{console.error(e),h(t,e,l)}));else if("getMarkersForCluster"===t)P.then((e=>{let t=n.cluster,r=n.rank_type,a=n.modality,l=n.annotation,i=o.GO(k(l)),c=x(l,i).fetchResults()[a],u=s.at(c,i.levels.indexOf(t),r);var f=[];m(u,f),postMessage({type:"setMarkersForCluster",resp:u,msg:"Success: GET_MARKER_GENE done"},f)})).catch((e=>{console.error(e),h(t,e,l)}));else if("getGeneExpression"===t)P.then((e=>{let t=n.gene,r=n.modality;var s=b.matrix.get(r).row(t);postMessage({type:"setGeneExpression",resp:{gene:t,expr:s},msg:"Success: GET_GENE_EXPRESSION done"},[s.buffer])})).catch((e=>{console.error(e),h(t,e,l)}));else if("computeCustomMarkers"===t)P.then((e=>{A.addSelection(n.id,n.selection),postMessage({type:"computeCustomMarkers",msg:"Success: COMPUTE_CUSTOM_MARKERS done"})})).catch((e=>{console.error(e),h(t,e,l)}));else if("getMarkersForSelection"===t)P.then((e=>{let t=n.rank_type,r=A.fetchResults(n.cluster)[n.modality],o=s.at(r,1,t);var a=[];m(o,a),postMessage({type:"setMarkersForCustomSelection",resp:o,msg:"Success: GET_MARKER_GENE done"},a)})).catch((e=>{console.error(e),h(t,e,l)}));else if("removeCustomMarkers"===t)P.then((e=>{A.removeSelection(n.id)})).catch((e=>{console.error(e),h(t,e,l)}));else if("getAnnotation"===t)P.then((e=>{let t,r,s=n.annotation;if(t=k(s),ArrayBuffer.isView(t))r={type:"array",values:t.slice()};else{let e=[],n={},s=new Int32Array(t.length);t.map(((t,r)=>{t in n||(n[t]=e.length,e.push(t)),s[r]=n[t]})),r={type:"factor",index:s,levels:e}}let o=[];m(r,o),postMessage({type:"setAnnotation",resp:{annotation:s,values:r},msg:"Success: GET_ANNOTATION done"},o)})).catch((e=>{console.error(e),h(t,e,l)}));else if("computeFeaturesetSummary"===t)P.then((async e=>{let t,{annotation:r,rank_type:s,cluster:a,modality:l}=n,i=s.indexOf("-");if(O===r){let e=A.fetchResults(a)[l];C.ready().then((n=>{t=C.computeEnrichment(e,1,s.slice(0,i),s.slice(i+1)),y("computeFeaturesetSummary",t)}))}else{let e=o.GO(k(r)),n=x(r,e).fetchResults()[l];C.ready().then((r=>{t=C.computeEnrichment(n,e.levels.indexOf(a),s.slice(0,i),s.slice(i+1)),y("computeFeaturesetSummary",t)}))}})).catch((e=>{console.error(e),h(t,e,l)}));else if("computeFeaturesetVSSummary"===t)P.then((async e=>{let t,{annotation:r,rank_type:s,left:a,right:l,modality:i}=n,c=s.indexOf("-");if(O===r){let e=A.computeVersus(a,l);C.ready().then((n=>{t=C.computeEnrichment(e.results[i],0,s.slice(0,c),s.slice(c+1)),y("computeFeaturesetVSSummary",t)}))}else{let e=o.GO(k(r)),a=x(r,e).computeVersus(e.levels.indexOf(n.left),e.levels.indexOf(n.right));C.ready().then((e=>{t=C.computeEnrichment(a.results[i],a.left,s.slice(0,c),s.slice(c+1)),y("computeFeaturesetVSSummary",t)}))}})).catch((e=>{console.error(e),h(t,e,l)}));else if("getFeatureScores"===t)P.then((e=>{let{index:t}=n;y("setFeatureScores",C.computePerCellScores(t))})).catch((e=>{console.error(e),h(t,e,l)}));else if("getFeatureGeneIndices"===t)P.then((e=>{let t,r,{index:a,cluster:l,annotation:i,modality:c,rank_type:u}=n,f=C.fetchFeatureSetIndices(a);if(O===i)t=A.fetchResults(n.cluster)[n.modality],r=s.at(t,1,n.rank_type);else{let e=o.GO(k(i));t=x(i,e).fetchResults()[c],r=s.at(t,e.levels.indexOf(l),u)}let d=r.ordering.map(((e,t)=>f.includes(e)?t:-100)).filter((e=>-100!==e)),m={};for(const[n,s]of Object.entries(r))m[n]=s.map(((e,t)=>d.includes(t)?e:-100)).filter((e=>-100!==e));y("setFeatureGeneIndices",m)})).catch((e=>{console.error(e),h(t,e,l)}));else if("initFeaturesetEnrich"===t)P.then((async e=>{let{modality:t}=n;C&&C.free(),C=new s.z7(b.features[t],{normalized:b.matrix.get(t)}),C.ready().then((e=>{let t=C.fetchCollectionDetails(),n=C.fetchSetDetails();y("feature_set_enrichment",{collections:t,sets:{names:n.names,descriptions:n.descriptions,sizes:n.sizes.slice(),collections:n.collections.slice()}})}))}));else if("computeCellAnnotation"===t){let{annotation:e,cluster:r,modality:a}=n,i={per_reference:{}},c=null;if(O===e)c=A.fetchResults(r);else{let t=x(e,o.GO(k(e)));c=t.fetchResults()}null!==c&&a in c&&(null===M&&(M=new s.qJ(b.features[a])),M.ready().then((()=>{i=M.computeLabels(c[a]),y("computeCellAnnotation",i)})).catch((e=>{console.error(e),h(t,e,l)})))}else console.error("MIM:::msg type incorrect"),h(t,"Type not defined",l)}}},t={};function n(r){var s=t[r];if(void 0!==s)return s.exports;var o=t[r]={id:r,loaded:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}n.m=e,n.x=()=>{var e=n.O(void 0,[764,705,141],(()=>n(2418)));return e=n.O(e)},(()=>{var e=[];n.O=(t,r,s,o)=>{if(!r){var a=1/0;for(u=0;u<e.length;u++){r=e[u][0],s=e[u][1],o=e[u][2];for(var l=!0,i=0;i<r.length;i++)(!1&o||a>=o)&&Object.keys(n.O).every((e=>n.O[e](r[i])))?r.splice(i--,1):(l=!1,o<a&&(a=o));if(l){e.splice(u--,1);var c=s();void 0!==c&&(t=c)}}return t}o=o||0;for(var u=e.length;u>0&&e[u-1][2]>o;u--)e[u]=e[u-1];e[u]=[r,s,o]}})(),n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce(((t,r)=>(n.f[r](e,t),t)),[])),n.u=e=>"static/js/"+e+"."+{141:"100c4f70",343:"dcaa5784",433:"b1b48770",705:"8c5fde0b",764:"9d24566f",814:"f3dd3a53"}[e]+".chunk.js",n.miniCssF=e=>{},n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),n.p="/kana/",(()=>{n.b=self.location+"/../../../";var e={418:1};n.f.i=(t,r)=>{e[t]||importScripts(n.p+n.u(t))};var t=self.webpackChunkkana=self.webpackChunkkana||[],r=t.push.bind(t);t.push=t=>{var s=t[0],o=t[1],a=t[2];for(var l in o)n.o(o,l)&&(n.m[l]=o[l]);for(a&&a(n);s.length;)e[s.pop()]=1;r(t)}})(),(()=>{var e=n.x;n.x=()=>Promise.all([764,705,141].map(n.e,n)).then(e)})();n.x()})();
//# sourceMappingURL=418.aa176550.chunk.js.map