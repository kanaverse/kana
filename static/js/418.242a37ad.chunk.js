(()=>{"use strict";var e={2418:(e,t,s)=>{var r,n=s(1522),o=s(7990),a=null;async function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(await a,!s){let t=r.result.transaction(["downloads"],"readonly").objectStore("downloads");var n=new Promise(((s,r)=>{var n=t.get(e);n.onsuccess=e=>{void 0!==n.result?s(n.result.payload):s(null)},n.onerror=t=>{r("failed to query DownloadsDB for ".concat(e,": ").concat(t.target.errorCode))}})),o=await n;if(null!==o)return o}var l;l=null==t?fetch(e):fetch(e,t);var i=await l;if(!i.ok)throw new Error("failed to download '"+e+"' ("+i.status+")");var c=await i.arrayBuffer();let u=r.result.transaction(["downloads"],"readwrite"),f=new Promise(((t,s)=>{u.oncomplete=e=>{t(null)},u.onerror=t=>{s(new Error("transaction error for saving ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}})),d=u.objectStore("downloads"),m=new Promise(((t,s)=>{var r=d.put({url:e,payload:c});r.onsuccess=e=>{t(!0)},r.onerror=t=>{s(new Error("failed to cache ".concat(e," in DownloadsDB: ").concat(t.target.errorCode)))}}));return await m,await f,c}var i=s(8166),c=s(9757);const u="https://cors-proxy.aaron-lun.workers.dev";async function f(e){const t=u+"/"+encodeURIComponent(e);try{const s=await async function(e,t,s,r){const n=await fetch(e);if(!n.ok)throw new Error("oops, failed to download '"+e+"'");const o=n.headers.get("content-length"),a=t(o),l=n.body.getReader(),i=[];let c=0;for(;;){const{done:e,value:t}=await l.read();if(e)break;i.push(t),c+=t.length,s(a,c)}let u=new Uint8Array(c),f=0;for(const d of i)u.set(d,f),f+=d.length;return r(a,c),u}(t,(s=>(postMessage({type:"DOWNLOAD for url: "+String(e),download:"START",url:String(e),total_bytes:String(s),msg:"Total size is "+String(s)+" bytes!"}),t)),((t,s)=>{postMessage({type:"DOWNLOAD for url: "+String(e),download:"PROGRESS",url:String(e),downloaded_bytes:String(s),msg:"Progress so far, got "+String(s)+" bytes!"})}),((t,s)=>{postMessage({type:"DOWNLOAD for url: "+String(e),download:"COMPLETE",url:String(e),msg:"Finished, got "+String(s)+" bytes!"})}));return s}catch(s){postMessage({type:"DOWNLOAD for url: "+String(e),download:"START",url:String(e),total_bytes:100});let r=await l(t);return postMessage({type:"DOWNLOAD for url: "+String(e),download:"COMPLETE",url:String(e)}),new Uint8Array(r)}}function d(e,t){if(e)if(Array.isArray(e))for(const s of e)d(s,t);else if(e.constructor==Object)for(const[s,r]of Object.entries(e))d(r,t);else if(ArrayBuffer.isView(e)){if(!(e.buffer instanceof ArrayBuffer))throw"only ArrayBuffers should be in the message payload";t.push(e.buffer)}}function m(e){postMessage({type:"".concat(e,"_START")})}function p(e,t){if("undefined"==typeof t)postMessage({type:"".concat(e,"_CACHE")});else{var s=[];d(t,s),postMessage({type:"".concat(e,"_DATA"),resp:t},s)}}function y(e,t,s){postMessage({type:"".concat(e,"_ERROR"),resp:{reason:t.toString(),fatal:s}})}function h(e){return Array.isArray(e)||ArrayBuffer.isView(e)}function g(e){let t,{all:s=!1,unique:r=!1,colname:o=null}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(h(e)){t=n.hp(e);const a=new Set(e);t.num_unique=a.size,a.size<=50&r&&(t.values=[...a].sort()),s&&(t._all_=e),"continuous"===t.type&&a.size<=50&&(t.type="both"),("string"===typeof o||o instanceof String)&&(t.name=o)}return t}n.Ug.setDownload(f),i.Iy(f),n.Zx.setDownload(f),i.uN((async(e,t,s)=>{let r=i.Az()+"/"+e,n=u+"/"+encodeURIComponent(r);if(null==t&&null==s){let e=await l(n);return new Response(e)}return fetch(n+"?start="+String(t)+"&end="+String(s))})),i.iC((async e=>{let t=i.oc()+"/"+e,s=await l(u+"/"+encodeURIComponent(t));return new Response(s)})),c.h.setDownloadFun(f),n.uw.ExperimentHub=c.h;s(4080);const w="K@\ud835\udf02a#$c3ll";"".concat(w,"::CLUSTERS"),"".concat(w,"::SELECTION"),"".concat(w,"::CLUSTERS");const S="".concat(w,"::SELECTION");let O=null,_={},E={},v=null,b={},R=null,A=null,C=null;function M(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if("H5AD"===e.format)return new n.U4(e.h5,t?e.options:{});if("SummarizedExperiment"===e.format)return new n.o5(e.rds,t?e.options:{});if("ZippedArtifactdb"===e.format)return new n.m0(e.zipname,new n.VM(e.zipfile),t?e.options:{});throw new Error("unknown format '"+e.format+"'")}function D(e,t){let s={};for(const n of e.cells.columnNames()){const t=e.cells.column(n);h(t)&&(s[n]=g(t,{all:!0,colname:n}))}let r={cells:{columns:s,numberOfCells:e.cells.numberOfRows()}};if("SummarizedExperiment"===t.format||"ZippedArtifactdb"===t.format){if(r.modality_features={},"modality_features"in e)for(const[n,o]of Object.entries(e.modality_features)){let e={};for(const t of o.columnNames()){const s=o.column(t);h(s)&&(e[t]=g(s,{all:!0,colname:t}))}r.modality_features[n]={columns:e,numberOfFeatures:o.numberOfRows(),rownames:Array.isArray(o.rowNames())}}}else{r.all_features={};let t={};for(const s of e.all_features.columnNames()){const r=e.all_features.column(s);h(r)&&(t[s]=g(r,{all:!0,colname:s}))}r.all_features={columns:t,numberOfFeatures:e.all_features.numberOfRows(),rownames:Array.isArray(e.all_features.rowNames())}}return"H5AD"===t.format?r.all_assay_names=e.all_assay_names:"SummarizedExperiment"!==t.format&&"ZippedArtifactdb"!==t.format||(r.modality_assay_names=e.modality_assay_names),r.reduced_dimension_names=e.reduced_dimension_names,r}function T(e,t){let s;return e in b||(s=new n.Jk(k(),t.ids.slice()),s.computeAll(),b[e]=s),b[e]}const x=e=>{if(-1!==e.indexOf(":::")){let t=e.split(":::");return v.cells.column(t[0]).column(t[1])}return v.cells.column(e)},k=()=>v.matrix;var N;onmessage=function(e){const{type:t,payload:s}=e.data;let l=!1;if("INIT"===t){l=!0;let e=Math.round(2*navigator.hardwareConcurrency/3),s=n.n_({numberOfThreads:e}),o=s.then((()=>n.fc()));o.then((e=>{O=e,postMessage({type:t,msg:"Success: analysis state created"})}));let i=(null===a&&(a=new Promise(((e,t)=>{(r=indexedDB.open("DownloadsDB",3)).onupgradeneeded=e=>{var t=e.target.result;try{t.deleteObjectStore("downloads")}catch(e){}t.createObjectStore("downloads",{keyPath:"url"})},r.onsuccess=()=>{e(null)},r.onerror=()=>{t("failed to initialize DownloadsDB")}}))),a);i.then((e=>{postMessage({type:"DownloadsDB_store",resp:e,msg:"Success: DownloadsDB initialized"})})).catch((e=>{console.error(e),postMessage({type:"DownloadsDB_ERROR",msg:"Error: Cannot initialize DownloadsDB"})})),(N=Promise.all([s,o,i])).then((()=>{postMessage({type:t,msg:"Success: bakana initialized"})})).catch((e=>{console.error(e),y(t,e,l)}))}else if("EXPLORE"===t)l=!0,N.then((async e=>{let t=s.inputs.files;if(null!==t){let e={};for(const[s,r]of Object.entries(t))"uid"in r&&r.uid in _&&(_[r.uid].clear(),delete _[s]),e[s]=M(r,!0),e[s].setOptions(r.options);for(const[s,r]of Object.entries(e)){v=await r.load();t[s];let e="inputs";m(e);let o={};for(const t of v.cells.columnNames()){let e=v.cells.column(t);if(h(e)){const s=g(e,{all:!1,unique:!0,colname:t});o[t]=s}}let a={annotations:o,genes:{},num_cells:v.cells.numberOfRows(),num_genes:{}};for(const[t,s]of Object.entries(v.features)){a.genes[t]={},a.num_genes[t]=s.numberOfRows();for(const e of s.columnNames()){let r=s.column(e);h(r)&&(a.genes[t][e]=r)}s.rowNames()&&(a.genes[t].rowNames=s.rowNames())}p(e,a);let l="embedding";m(l);let i={};for(const[t,s]of Object.entries(v.reduced_dimensions))"pca"!==t.toLowerCase()&&(i[t]={x:s[0].slice(),y:s[1].slice()});p(l,i),R&&R.free(),R=new n.g0(v.matrix)}}})).catch((e=>{console.error(e),y(t,e,l)}));else if("PREFLIGHT_INPUT"===t)N.then((async e=>{let t={};try{let e={},r={};for(const[t,n]of Object.entries(s.inputs.files))if("uid"in n)n.uid in _||(_[n.uid]=M(n),E[n.uid]=await _[n.uid].summary()),e[t]=_[n.uid],r[t]=D(E[n.uid],n);else{let s=M(n);e[t]=s,r[t]=D(e[t],n)}t.status="SUCCESS",t.details=r}catch(r){console.error(r),t.status="ERROR",t.reason=r.toString()}postMessage({type:"PREFLIGHT_INPUT_DATA",resp:t,msg:"Success: PREFLIGHT_INPUT done"})})).catch((e=>{console.error(e),y(t,e,l)}));else if("computeVersusClusters"===t)N.then((e=>{let t=s.rank_type,r=s.modality,a=s.annotation,l=o.GO(x(a)),i=T(a,l).computeVersus(l.levels.indexOf(s.left),l.levels.indexOf(s.right)),c=n.at(i.results[r],i.left,t);var u=[];d(c,u),postMessage({type:"computeVersusClusters",resp:c,msg:"Success: COMPUTE_VERSUS_CLUSTERS done"},u)})).catch((e=>{console.error(e),y(t,e,l)}));else if("computeVersusSelections"===t)N.then((e=>{let t=s.rank_type,r=R.computeVersus(s.left,s.right),o=n.at(r.results[s.modality],s.left,t);var a=[];d(o,a),postMessage({type:"computeVersusSelections",resp:o,msg:"Success: COMPUTE_VERSUS_SELECTIONS done"},a)})).catch((e=>{console.error(e),y(t,e,l)}));else if("getMarkersForCluster"===t)N.then((e=>{let t=s.cluster,r=s.rank_type,a=s.modality,l=s.annotation,i=o.GO(x(l)),c=T(l,i).fetchResults()[a],u=n.at(c,i.levels.indexOf(t),r);var f=[];d(u,f),postMessage({type:"setMarkersForCluster",resp:u,msg:"Success: GET_MARKER_GENE done"},f)})).catch((e=>{console.error(e),y(t,e,l)}));else if("getGeneExpression"===t)N.then((e=>{let t=s.gene,r=s.modality;var n=v.matrix.get(r).row(t);postMessage({type:"setGeneExpression",resp:{gene:t,expr:n},msg:"Success: GET_GENE_EXPRESSION done"},[n.buffer])})).catch((e=>{console.error(e),y(t,e,l)}));else if("computeCustomMarkers"===t)N.then((e=>{R.addSelection(s.id,s.selection),postMessage({type:"computeCustomMarkers",msg:"Success: COMPUTE_CUSTOM_MARKERS done"})})).catch((e=>{console.error(e),y(t,e,l)}));else if("getMarkersForSelection"===t)N.then((e=>{let t=s.rank_type,r=R.fetchResults(s.cluster)[s.modality],o=n.at(r,1,t);var a=[];d(o,a),postMessage({type:"setMarkersForCustomSelection",resp:o,msg:"Success: GET_MARKER_GENE done"},a)})).catch((e=>{console.error(e),y(t,e,l)}));else if("removeCustomMarkers"===t)N.then((e=>{R.removeSelection(s.id)})).catch((e=>{console.error(e),y(t,e,l)}));else if("getAnnotation"===t)N.then((e=>{let t,r,n=s.annotation;if(t=x(n),ArrayBuffer.isView(t))r={type:"array",values:t.slice()};else{let e=[],s={},n=new Int32Array(t.length);t.map(((t,r)=>{t in s||(s[t]=e.length,e.push(t)),n[r]=s[t]})),r={type:"factor",index:n,levels:e}}let o=[];d(r,o),postMessage({type:"setAnnotation",resp:{annotation:n,values:r},msg:"Success: GET_ANNOTATION done"},o)})).catch((e=>{console.error(e),y(t,e,l)}));else if("computeFeaturesetSummary"===t)N.then((async e=>{let t,{annotation:r,rank_type:n,cluster:a,modality:l}=s,i=n.indexOf("-");if(S===r){let e=R.fetchResults(a)[l];A.ready().then((s=>{t=A.computeEnrichment(e,1,n.slice(0,i),n.slice(i+1)),p("computeFeaturesetSummary",t)}))}else{let e=o.GO(x(r)),s=T(r,e).fetchResults()[l];A.ready().then((r=>{t=A.computeEnrichment(s,e.levels.indexOf(a),n.slice(0,i),n.slice(i+1)),p("computeFeaturesetSummary",t)}))}})).catch((e=>{console.error(e),y(t,e,l)}));else if("computeFeaturesetVSSummary"===t)N.then((async e=>{let t,{annotation:r,rank_type:n,left:a,right:l,modality:i}=s,c=n.indexOf("-");if(S===r){let e=R.computeVersus(a,l);A.ready().then((s=>{t=A.computeEnrichment(e.results[i],0,n.slice(0,c),n.slice(c+1)),p("computeFeaturesetVSSummary",t)}))}else{let e=o.GO(x(r)),a=T(r,e).computeVersus(e.levels.indexOf(s.left),e.levels.indexOf(s.right));A.ready().then((e=>{t=A.computeEnrichment(a.results[i],a.left,n.slice(0,c),n.slice(c+1)),p("computeFeaturesetVSSummary",t)}))}})).catch((e=>{console.error(e),y(t,e,l)}));else if("getFeatureScores"===t)N.then((e=>{let{index:t}=s;p("setFeatureScores",A.computePerCellScores(t))})).catch((e=>{console.error(e),y(t,e,l)}));else if("getFeatureGeneIndices"===t)N.then((e=>{let t,r,{index:a,cluster:l,annotation:i,modality:c,rank_type:u}=s,f=A.fetchFeatureSetIndices(a);if(S===i)t=R.fetchResults(s.cluster)[s.modality],r=n.at(t,1,s.rank_type);else{let e=o.GO(x(i));t=T(i,e).fetchResults()[c],r=n.at(t,e.levels.indexOf(l),u)}let d=r.ordering.map(((e,t)=>f.includes(e)?t:-100)).filter((e=>-100!==e)),m={};for(const[s,n]of Object.entries(r))m[s]=n.map(((e,t)=>d.includes(t)?e:-100)).filter((e=>-100!==e));p("setFeatureGeneIndices",m)})).catch((e=>{console.error(e),y(t,e,l)}));else if("initFeaturesetEnrich"===t)N.then((async e=>{let{modality:t}=s;A&&A.free(),A=new n.z7(v.features[t],{normalized:v.matrix.get(t)}),A.ready().then((e=>{let t=A.fetchCollectionDetails(),s=A.fetchSetDetails();p("feature_set_enrichment",{collections:t,sets:{names:s.names,descriptions:s.descriptions,sizes:s.sizes.slice(),collections:s.collections.slice()}})}))}));else if("computeCellAnnotation"===t){let{annotation:e,cluster:r,modality:a}=s,i={per_reference:{}},c=null;if(S===e)c=R.fetchResults(r);else{let t=T(e,o.GO(x(e)));c=t.fetchResults()}null!==c&&a in c&&(null===C&&(C=new n.qJ(v.features[a])),C.ready().then((()=>{i=C.computeLabels(c[a]),p("computeCellAnnotation",i)})).catch((e=>{console.error(e),y(t,e,l)})))}else console.error("MIM:::msg type incorrect"),y(t,"Type not defined",l)}}},t={};function s(r){var n=t[r];if(void 0!==n)return n.exports;var o=t[r]={id:r,loaded:!1,exports:{}};return e[r].call(o.exports,o,o.exports,s),o.loaded=!0,o.exports}s.m=e,s.x=()=>{var e=s.O(void 0,[764,705,141],(()=>s(2418)));return e=s.O(e)},(()=>{var e=[];s.O=(t,r,n,o)=>{if(!r){var a=1/0;for(u=0;u<e.length;u++){r=e[u][0],n=e[u][1],o=e[u][2];for(var l=!0,i=0;i<r.length;i++)(!1&o||a>=o)&&Object.keys(s.O).every((e=>s.O[e](r[i])))?r.splice(i--,1):(l=!1,o<a&&(a=o));if(l){e.splice(u--,1);var c=n();void 0!==c&&(t=c)}}return t}o=o||0;for(var u=e.length;u>0&&e[u-1][2]>o;u--)e[u]=e[u-1];e[u]=[r,n,o]}})(),s.d=(e,t)=>{for(var r in t)s.o(t,r)&&!s.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},s.f={},s.e=e=>Promise.all(Object.keys(s.f).reduce(((t,r)=>(s.f[r](e,t),t)),[])),s.u=e=>"static/js/"+e+"."+{141:"100c4f70",343:"dcaa5784",433:"b1b48770",705:"8c5fde0b",764:"9d24566f",814:"f3dd3a53"}[e]+".chunk.js",s.miniCssF=e=>{},s.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}(),s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),s.p="/kana/",(()=>{s.b=self.location+"/../../../";var e={418:1};s.f.i=(t,r)=>{e[t]||importScripts(s.p+s.u(t))};var t=self.webpackChunkkana=self.webpackChunkkana||[],r=t.push.bind(t);t.push=t=>{var n=t[0],o=t[1],a=t[2];for(var l in o)s.o(o,l)&&(s.m[l]=o[l]);for(a&&a(s);n.length;)e[n.pop()]=1;r(t)}})(),(()=>{var e=s.x;s.x=()=>Promise.all([764,705,141].map(s.e,s)).then(e)})();s.x()})();
//# sourceMappingURL=418.242a37ad.chunk.js.map